<template>
  <div class="min-h-screen bg-gradient-to-br from-slate-50 via-gray-50 to-blue-50">
    <!-- Header -->
    <div class="bg-white/90 backdrop-blur-xl shadow-sm border-b border-gray-100/80">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3 cursor-pointer group" @click="refreshPage">
            <div class="relative">
              <div class="w-10 h-10 bg-gradient-to-br from-indigo-500/80 via-purple-600/80 to-blue-500/80 rounded-2xl flex items-center justify-center shadow-lg rotate-3 transform group-hover:rotate-0 transition-transform duration-300">
                <span class="text-white font-bold text-lg">S</span>
              </div>
              <div class="absolute -top-1 -right-1 w-4 h-4 bg-gradient-to-r from-emerald-400 to-teal-500 rounded-full animate-pulse"></div>
            </div>
            <div>
              <h1 class="text-2xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent group-hover:from-indigo-600 group-hover:to-purple-600 transition-all duration-300">
                Shannon Insight
              </h1>
              <p class="text-sm text-gray-500 font-medium group-hover:text-gray-600 transition-colors duration-300">Advanced Data Intelligence Platform</p>
            </div>
          </div>
          <div class="hidden md:flex items-center space-x-2">
            <div class="px-3 py-1.5 bg-emerald-100 text-emerald-700 text-xs font-semibold rounded-full">
              Beta v1.0
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Hero Search Section -->
      <div class="relative overflow-hidden mb-8">
        <div class="absolute inset-0 bg-gradient-to-br from-slate-400/15 via-slate-500/15 to-slate-600/15 rounded-3xl transform rotate-1"></div>
        <!-- <div class="absolute inset-0 bg-gradient-to-br from-indigo-600/20 via-purple-600/20 to-pink-600/20 rounded-3xl transform rotate-1"></div> -->
        <!-- <div class="relative bg-gradient-to-br from-indigo-600 via-purple-700 to-pink-600 rounded-3xl p-6 lg:p-8 text-white shadow-2xl"> -->
          <div class="relative bg-gradient-to-br from-blue-900/70 to-purple-700/70 rounded-3xl p-6 lg:p-8 text-white shadow-2xl backdrop-blur-sm">
          <!-- Background Pattern -->
          <div class="absolute inset-0 opacity-10">
            <div class="absolute top-0 left-0 w-40 h-40 bg-white rounded-full -translate-x-20 -translate-y-20"></div>
            <div class="absolute bottom-0 right-0 w-32 h-32 bg-white rounded-full translate-x-16 translate-y-16"></div>
            <div class="absolute top-1/2 left-1/2 w-24 h-24 bg-white rounded-full -translate-x-12 -translate-y-12"></div>
          </div>
          
          <div class="relative z-10">
            <div class="text-center mb-6">
              <h2 class="text-xl lg:text-2xl font-semibold mb-3 leading-tight">
                ë°ì´í„° ì† ìˆ¨ê²¨ì§„ 
                <span class="bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent">ì¸ì‚¬ì´íŠ¸</span>ë¥¼ 
                ë°œê²¬í•˜ì„¸ìš”
              </h2>
              <!-- <p class="text-lg text-white/90 font-medium">ìì—°ì–´ ì§ˆë¬¸ìœ¼ë¡œ ë³µí•©ì ì¸ ë°ì´í„° ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤</p> -->
            </div>
            
            <!-- Search Input -->
            <div class="max-w-2xl mx-auto mb-6">
              <div class="relative group">
                <div class="absolute inset-0 bg-gradient-to-r from-white/20 to-white/10 rounded-2xl blur-xl group-hover:blur-2xl transition-all duration-300"></div>
                <div class="relative flex items-center">
                  <div class="flex items-center flex-1 bg-white rounded-2xl shadow-xl overflow-hidden">
                    <svg class="w-5 h-5 text-gray-400 ml-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input
                      v-model="userQuery"
                      placeholder="ìì—°ì–´ë¡œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"
                      class="flex-1 px-4 py-4 text-gray-900 placeholder-gray-500 focus:outline-none text-base"
                      @keyup.enter="executeQuery"
                    />
                    <button
                      @click="executeQuery"
                      :disabled="loading || !userQuery.trim()"
                      class="m-2 flex items-center justify-center w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed group"
                    >
                      <div v-if="loading" class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
                      <svg v-else class="w-6 h-6 group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 5 7 7-7 7"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Search Tags -->
            <div class="flex flex-wrap justify-center items-center gap-3 mb-8">
              <span class="text-white/80 text-sm font-medium">ê²€ìƒ‰ì–´ ì˜ˆì‹œ:</span>
              <button 
                v-for="(query, idx) in sampleQueries" 
                :key="idx"
                @click="loadSampleQuery(idx)"
                class="group flex items-center gap-2 px-3 py-2 bg-white/20 hover:bg-white/30 rounded-full text-xs font-medium transition-all duration-200 backdrop-blur-sm border border-white/20"
              >
                <!-- <span v-if="query.title === 'ì „ê¸°ì°¨ ì¶©ì „ì†Œ'">âš¡</span> -->
                <!-- <span v-else-if="query.title === 'ì†Œë“ ë¶„í¬'">ğŸ“Š</span> -->
                <!-- <span v-else>ğŸ”„</span> -->
                <span>{{ query.title }}</span>
                <span class="text-xs px-1 py-0.5 rounded text-white/70 font-medium" 
                      :class="{
                        'bg-green-500/50': query.difficulty === 'basic',
                        'bg-red-500/50': query.difficulty === 'advanced'
                      }">
                  {{ query.difficulty === 'basic' ? 'basic' : 'advanced' }}
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Analysis Tips Slider Section - First Screen Only -->
      <div v-if="!loading && !result" class="mb-12">
        <div class="relative overflow-hidden bg-white rounded-3xl shadow-sm border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-600 flex">
                <span class="text-xl mr-2">ğŸ’¡</span>
                ë¶„ì„ íŒ
                </h3>
                <div class="flex space-x-1">
                <button
                    v-for="(tip, index) in analysisTips"
                    :key="index"
                    @click="currentTipIndex = index"
                    :class="[
                    'w-2 h-2 rounded-full transition-all duration-300',
                    currentTipIndex === index ? 'bg-indigo-500' : 'bg-gray-300'
                    ]"
                ></button>
                </div>
            </div>
            </div>
            
            <div class="relative h-56 overflow-hidden">
            <div 
                class="flex transition-transform duration-500 ease-in-out h-full"
                :style="{ transform: `translateX(-${currentTipIndex * 100}%)` }"
            >
                <div 
                v-for="(tip, index) in analysisTips" 
                :key="index"
                class="w-full flex-shrink-0 px-6 py-12 flex items-center justify-center"
                >
                <div class="text-center max-w-md">
                    <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mb-4 mx-auto shadow-lg">
                        <!-- ê²€ìƒ‰ ì•„ì´ì½˜ -->
                        <svg v-if="tip.icon === 'search'" class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <!-- ì°¨íŠ¸ ì•„ì´ì½˜ -->
                        <svg v-else-if="tip.icon === 'chart'" class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <!-- íŠ¸ë Œë“œ ì•„ì´ì½˜ -->
                        <svg v-else-if="tip.icon === 'trend'" class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <h4 class="font-bold text-gray-800 mb-2 text-lg text-center">{{ tip.title }}</h4>
                    <p class="text-sm text-gray-600 leading-relaxed mb-3 text-center">{{ tip.description }}</p>
                    <div class="text-xs text-gray-500 bg-gray-50 px-3 py-1 rounded-full inline-block">
                        {{ tip.example }}
                    </div>
                </div>
                </div>
            </div>
            </div>
        </div>
      </div>

      <!-- Feature Boxes Section - First Screen Only -->
      <div v-if="!loading && !result" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="group relative overflow-hidden bg-white rounded-3xl shadow-lg border border-gray-100 hover:shadow-2xl transition-all duration-500 hover:-translate-y-2">
          <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-cyan-50 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          <div class="relative p-6 text-center">
            <div class="flex flex-col items-center mb-4">
              <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mb-4 shadow-lg group-hover:scale-110 transition-transform duration-300">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-bold text-gray-800">ë³µí•©ì¶”ë¡ </h3>
            </div>
            <p class="text-gray-600 text-sm leading-relaxed mb-4">
              ì—¬ëŸ¬ ë°ì´í„°ì…‹ì„ ì—°ê²°í•˜ì—¬ ë³µí•©ì ì¸ íŒ¨í„´ê³¼ ì¸ê³¼ê´€ê³„ ì¶”ë¡ 
            </p>
            <div class="flex items-center justify-center text-xs text-gray-500">
              <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
              ê³ ê¸‰ ë¶„ì„ ê¸°ëŠ¥
            </div>
          </div>
        </div>

        <div class="group relative overflow-hidden bg-white rounded-3xl shadow-lg border border-gray-100 hover:shadow-2xl transition-all duration-500 hover:-translate-y-2">
          <div class="absolute inset-0 bg-gradient-to-br from-purple-50 to-pink-50 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          <div class="relative p-6 text-center">
            <div class="flex flex-col items-center mb-4">
              <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center mb-4 shadow-lg group-hover:scale-110 transition-transform duration-300">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                </svg>
              </div>
              <h3 class="text-lg font-bold text-gray-800">ë‹¤ì–‘í•œ ë°ì´í„° ì†ŒìŠ¤</h3>
            </div>
            <p class="text-gray-600 text-sm leading-relaxed mb-4">
              ê³µê³µë°ì´í„°, í†µê³„ì²­, ì§€ìì²´ ë“± ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë°ì´í„° ì´ 1,698,462 íŠ¸ë¦¬í”Œ
            </p>
            <div class="flex items-center justify-center text-xs text-gray-500">
              <span class="w-2 h-2 bg-purple-400 rounded-full mr-2"></span>
              ì¶œì²˜ ì œê³µ
            </div>
          </div>
        </div>

        <div class="group relative overflow-hidden bg-white rounded-3xl shadow-lg border border-gray-100 hover:shadow-2xl transition-all duration-500 hover:-translate-y-2">
          <div class="absolute inset-0 bg-gradient-to-br from-emerald-50 to-teal-50 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          <div class="relative p-6 text-center">
            <div class="flex flex-col items-center mb-4">
              <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-2xl flex items-center justify-center mb-4 shadow-lg group-hover:scale-110 transition-transform duration-300">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-bold text-gray-800">ì‹¤ì‹œê°„ ì‹œê°í™”</h3>
            </div>
            <p class="text-gray-600 text-sm leading-relaxed mb-4">
              ì¸í„°ë™í‹°ë¸Œ ì°¨íŠ¸ì™€ ì§€ë„ë¡œ ì§ê´€ì ì¸ ë°ì´í„° í‘œí˜„
            </p>
            <div class="flex items-center justify-center text-xs text-gray-500">
              <span class="w-2 h-2 bg-emerald-400 rounded-full mr-2"></span>
              ì°¨íŠ¸, ì§€ë„ ì‹œê°í™”
            </div>
          </div>
        </div>

      </div>

      <!-- Loading State -->
      <div v-if="loading" class="text-center py-16">
        <!-- ë³µí•© ì¶”ë¡  ì§„í–‰ ìƒíƒœ (query3) -->
        <div v-if="complexReasoningProgress.isActive" class="max-w-2xl mx-auto">
          <div class="bg-white rounded-2xl shadow-xl border border-gray-200/60 p-8 mb-6">
            <div class="flex items-center justify-center mb-6">
              <div class="relative">
                <div class="w-16 h-16 border-4 border-indigo-200 rounded-full animate-spin"></div>
                <div class="absolute inset-0 w-16 h-16 border-4 border-transparent border-t-indigo-600 rounded-full animate-spin"></div>
              </div>
            </div>
            
            <h3 class="text-xl font-bold text-gray-800 mb-2">
              {{ complexReasoningProgress.stepTitle }}
            </h3>
            <p class="text-gray-600 mb-4">
              {{ complexReasoningProgress.stepDescription }}
            </p>
            
            <!-- ì§„í–‰ë¥  ë°” -->
            <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
              <div 
                class="bg-gradient-to-r from-purple-500 to-indigo-600 h-2 rounded-full transition-all duration-500 ease-out"
                :style="{ width: `${(complexReasoningProgress.currentStep / complexReasoningProgress.totalSteps) * 100}%` }"
              ></div>
            </div>
            
            <p class="text-gray-500 text-sm">
              ë‹¨ê³„ {{ complexReasoningProgress.currentStep }} / {{ complexReasoningProgress.totalSteps }}
            </p>
          </div>
        </div>
        
        <!-- ì¼ë°˜ ë¡œë”© ìƒíƒœ -->
        <div v-else>
          <div class="relative inline-flex items-center justify-center mb-6">
            <div class="w-24 h-24 rounded-full flex items-center justify-center">
              <div class="relative">
                <div class="w-12 h-12 border-4 border-indigo-200 rounded-full animate-spin"></div>
                <div class="absolute inset-0 w-12 h-12 border-4 border-transparent border-t-indigo-600 rounded-full animate-spin"></div>
              </div>
            </div>
            <!-- <div class="absolute -inset-4 bg-gradient-to-r from-indigo-500/20 via-purple-500/20 to-pink-500/20 rounded-full blur-xl animate-pulse"></div> -->
          </div>
          <h3 class="text-xl font-semibold text-gray-800 mb-2">
            {{ isAdvancedQuery ? 'ë³µí•© ì¶”ë¡ ì„ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...' : 'ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...' }}
          </h3>
          <p class="text-gray-600 max-w-md mx-auto">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</p>
        </div>
      </div>

      <!-- Results Section -->
      <div v-if="result && !loading" class="space-y-8">

        <!-- 1. Analysis Section -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
              <span class="w-8 h-8 bg-amber-100 text-amber-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">1</span>
              ë¶„ì„ ê²°ê³¼
            </h3>
          </div>
          <div class="px-6 lg:px-8 py-8">
            <div v-if="result.analysis">
              <!-- í‚¤ì›Œë“œ ë°•ìŠ¤íƒ­ -->
              <div v-if="analysisKeywords.length > 0" class="mb-8">
                <h4 class="text-lg font-semibold text-gray-800 mb-4 flex">
                  <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold flex items-center justify-center mr-2">ğŸ“Š</span>
                  í•µì‹¬ ì¸ì‚¬ì´íŠ¸
                </h4>
                <div class="flex flex-wrap gap-3">
                  <span 
                    v-for="keyword in analysisKeywords" 
                    :key="keyword.text"
                    :class="[
                      'px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 hover:scale-105',
                      keyword.type === 'highlight' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                      keyword.type === 'number' ? 'bg-green-100 text-green-800 border border-green-200' :
                      keyword.type === 'location' ? 'bg-purple-100 text-purple-800 border border-purple-200' :
                      'bg-blue-100 text-blue-800 border border-blue-200'
                    ]"
                  >
                    {{ keyword.text }}
                  </span>
                </div>
              </div>

              <!-- ìƒì„¸ ë¶„ì„ ë‚´ìš© -->
              <div class="prose prose-gray max-w-none">
                <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                  <span class="w-6 h-6 bg-gray-100 text-gray-600 rounded-lg text-xs font-bold flex items-center justify-center mr-2">ğŸ“</span>
                  ìƒì„¸ ë¶„ì„
                </h4>
                <div v-html="formattedAnalysis" class="text-gray-700 leading-relaxed text-base bg-gray-50 rounded-xl p-6 border border-gray-200"></div>
              </div>

              <!-- ì¶”ê°€ ë¶„ì„ ì œì•ˆ (query2ì¸ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
              <div v-if="result.queryType === 2" class="mt-8 pt-6 border-t border-gray-200">
                <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                  <span class="w-6 h-6 bg-purple-100 text-purple-600 rounded-lg text-xs font-bold flex items-center justify-center mr-2">ğŸ’¡</span>
                  ì¶”ê°€ ë¶„ì„ ì œì•ˆ
                </h4>
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 border border-purple-200">
                  <p class="text-gray-700 mb-4 font-medium">
                    ì†Œë“ ë¶„í¬ ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ ë” ê¹Šì´ ìˆëŠ” ì¸ì‚¬ì´íŠ¸ë¥¼ ë°œê²¬í•´ë³´ì„¸ìš”.
                  </p>
                  <button
                    @click="onClickExecuteAdvancedQuery"
                    :disabled="loading"
                    class="group flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <div v-if="loading" class="animate-spin w-4 h-4 border-2 border-gray-500 border-t-transparent rounded-full"></div>
                    <svg v-else class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                    <span class="text-sm font-medium">ì˜ˆì‹œ: ì§€ì—­ë³„ ì „ê¸°ì°¨ ì¶©ì „ì†Œ ê°œìˆ˜ëŠ” ì†Œë“ ìˆ˜ì¤€ê³¼ ìƒê´€ì„±ì´ ìˆì„ê¹Œ?</span>
                  </button>
                  <!-- <p class="text-sm text-gray-600 mt-3">
                    ê³ ê¸‰ ë¶„ì„ì„ í†µí•´ ì†Œë“ê³¼ ì „ê¸°ì°¨ ì¶©ì „ì†Œ ê°„ì˜ ìƒê´€ê´€ê³„ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
                  </p> -->
                </div>
              </div>
            </div>
            <div v-else class="text-gray-500 text-center py-8">
              ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
        </div>

        <!-- 2. Visualization Section -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold text-gray-800 flex items-center">
                <span class="w-8 h-8 bg-purple-100 text-purple-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">2</span>
                <span v-if="shouldShowMap">ì¶©ì „ì†Œ ìœ„ì¹˜ ì§€ë„</span>
                <span v-else-if="result.queryType === 3">ë³µì§€ ì·¨ì•½ì„± ë¶„ì„</span>  
                <span v-else-if="result.queryType === 4">ì†Œë“ê³¼ ì¶©ì „ì†Œ ìƒê´€ê´€ê³„ ë¶„ì„</span>
                <span v-else>ë°ì´í„° ì‹œê°í™”</span>
              </h3>
              
              <!-- ë³µì§€ ë¶„ì„ ì°¨íŠ¸ íƒ€ì… ì„ íƒ ë²„íŠ¼ -->
              <div v-if="result.queryType === 3" class="flex gap-2">
                <button
                  @click="welfareChartType = 'line'"
                  :class="[
                    'px-3 py-1 text-xs rounded-full transition-colors',
                    welfareChartType === 'line' 
                      ? 'bg-purple-500 text-white' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  ]"
                >
                  ì§€ì—­ë³„ í˜„í™©
                </button>
                <button
                  @click="welfareChartType = 'bar'"
                  :class="[
                    'px-3 py-1 text-xs rounded-full transition-colors',
                    welfareChartType === 'bar' 
                      ? 'bg-purple-500 text-white' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  ]"
                >
                  ì¢…í•©ì ìˆ˜
                </button>
              </div>
            </div>
          </div>
          
          <div class="px-6 lg:px-8 py-8">
            <!-- Map for Query 1 - Charging Stations -->
            <div v-if="shouldShowMap" class="h-96 relative rounded-lg overflow-hidden border border-gray-200">
              <div ref="mapContainer" class="w-full h-full"></div>
            </div>
            
            <!-- Welfare Analysis Charts for Query 3 -->
            <div v-else-if="result.queryType === 3" class="h-[500px] relative">
              <!-- ë°ì´í„° ì—†ìŒ ì•ˆë‚´ -->
              <div v-if="!hasWelfareChartData" class="flex items-center justify-center h-full">
                <div class="text-gray-400 text-base">ì‹œê°í™”í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
              </div>
              <!-- Line Chart for Regional Status -->
              <div v-else class="h-full w-full flex flex-col">
                <div :class="{ 'hidden': welfareChartType !== 'line' }" class="h-full w-full flex-1">
                  <canvas ref="welfareLineChart" style="width:100%;height:100%;display:block;"></canvas>
                </div>
                <!-- Bar Chart for Comprehensive Score -->
                <div :class="{ 'hidden': welfareChartType !== 'bar' }" class="h-full w-full flex-1">
                  <canvas ref="welfareBarChart" style="width:100%;height:100%;display:block;"></canvas>
                </div>
              </div>
            </div>
            
            <!-- Scatter Chart for Query 4 -->
            <div v-else-if="shouldShowScatterChart" class="h-[500px] relative">
              <!-- ë¡œë”© ì¤‘ì¼ ë•Œ ìŠ¤ì¼ˆë ˆí†¤ í‘œì‹œ -->
              <div v-if="loading" class="bg-gray-100 rounded-xl p-4 animate-pulse">
                <div class="h-6 bg-gray-200 rounded mb-4"></div>
                <div class="h-80 bg-gray-200 rounded"></div>
              </div>
              
              <!-- ì‹¤ì œ ì‚°ì ë„ ì°¨íŠ¸ -->
              <div v-else class="relative w-full h-[500px]">
                <canvas ref="chartCanvas" style="width:100%;height:100%"></canvas>
              </div>
            </div>
            
            <!-- Bar Chart for Query 2 -->
            <div v-else-if="shouldShowBarChart" class="h-[400px] relative">
              <!-- Query 2: ì†Œë“ ë¶„í¬ - ë¡œë”© ìƒíƒœ í‘œì‹œ ì¶”ê°€ -->
              <div v-if="result.queryType === 2">
                <!-- ë¡œë”© ì¤‘ì¼ ë•Œ ìŠ¤ì¼ˆë ˆí†¤ í‘œì‹œ -->
                <div v-if="loading" class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                  <div class="bg-gray-100 rounded-xl p-4 animate-pulse">
                    <div class="h-6 bg-gray-200 rounded mb-4"></div>
                    <div class="h-80 bg-gray-200 rounded"></div>
                  </div>
                  <div class="bg-gray-100 rounded-xl p-4 animate-pulse">
                    <div class="h-6 bg-gray-200 rounded mb-4"></div>
                    <div class="h-80 bg-gray-200 rounded"></div>
                  </div>
                </div>
                
                <!-- ì‹¤ì œ ì°¨íŠ¸ -->
                <div v-else class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                  <div class="bg-gray-50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 text-center">ìƒìœ„ 10ê°œ ì§€ì—­</h4>
                    <div class="h-80">
                      <canvas ref="topChartCanvas" style="width:100%;height:100%"></canvas>
                    </div>
                  </div>
                  <div class="bg-gray-50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 text-center">í•˜ìœ„ 10ê°œ ì§€ì—­</h4>
                    <div class="h-80">
                      <canvas ref="bottomChartCanvas" style="width:100%;height:100%"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              
            </div>
            <!-- Pie Chart for Query 3 (legacy) -->
            <div v-else-if="shouldShowPieChart" class="h-96 relative">
              <canvas ref="pieChartCanvas"></canvas>
            </div>

            <!-- No Chart Available -->
            <div v-else class="h-96 flex items-center justify-center text-gray-500">
              <div class="text-center">
                <div class="text-4xl mb-4">ğŸ“Š</div>
                <p class="text-lg">ì‹œê°í™”í•  ìˆ˜ ìˆëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 2.5. Reasoning Steps Section (Advanced queries only) -->
        <div v-if="result.reasoningSteps?.length" class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
              <span class="w-8 h-8 bg-rose-100 text-rose-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">ğŸ§ </span>
              ì¶”ë¡  ê³¼ì •
            </h3>
          </div>
          <div class="px-6 lg:px-8 py-8">
            <div class="space-y-6">
              <div v-for="step in result.reasoningSteps" :key="step.step" 
                   class="flex items-start space-x-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-lg flex items-center justify-center text-sm font-bold">
                  {{ step.step }}
                </div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800 mb-2">{{ step.title }}</h4>
                  <p class="text-gray-600 text-sm mb-2">{{ step.description }}</p>
                  <div class="text-xs text-gray-500 bg-white px-3 py-2 rounded-lg border">
                    <code>{{ step.detail }}</code>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 3. SPARQL Query Section -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold text-gray-800 flex items-center">
                <span class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">3</span>
                ì‹¤í–‰ëœ SPARQL ì¿¼ë¦¬
              </h3>
              <button
                @click="showQuery = !showQuery"
                class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg transition-colors text-sm font-medium"
              >
                {{ showQuery ? 'ì ‘ê¸°' : 'í¼ì¹˜ê¸°' }}
                <span class="transform transition-transform" :class="{ 'rotate-180': showQuery }">
                  â–¼
                </span>
              </button>
            </div>
          </div>
          
          <div v-if="showQuery" class="px-6 lg:px-8 pb-6">
            <div class="bg-gray-900 rounded-xl p-6 overflow-x-auto">
              <pre class="text-green-400 text-sm whitespace-pre-wrap font-mono leading-relaxed">{{ result.sparqlQuery }}</pre>
            </div>
          </div>
        </div>

        <!-- 4. Results Table Section -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
              <span class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">4</span>
              ì¿¼ë¦¬ ê²°ê³¼ ì˜ˆì‹œ
            </h3>
          </div>
          <div v-if="tableColumns.length > 0" class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-gray-50 border-b border-gray-200">
                  <th v-for="column in tableColumns" :key="column" 
                      class="px-6 py-4 text-left font-semibold text-gray-700 text-sm">
                    {{ column }}
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(row, idx) in displayResults" :key="idx" 
                    class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                  <td v-for="column in tableColumns" :key="column" class="px-6 py-4 text-gray-600 text-sm">
                    {{ formatCellValue(row[column]) }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div v-else class="px-6 py-8 text-center text-gray-500">
            í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
          <div v-if="result.results && result.results.length > 10" class="px-6 lg:px-8 py-4 bg-gray-50 border-t border-gray-100">
            <p class="text-sm text-gray-500">
              ì´ <span class="font-semibold text-gray-700">{{ result.results.length }}ê°œ</span> ê²°ê³¼ ì¤‘ ìƒìœ„ 5ê°œë§Œ í‘œì‹œ
            </p>
          </div>
        </div>

        <!-- 5. Data Source -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
              <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">5</span>
              ë°ì´í„° ì¶œì²˜
            </h3>
          </div>

          <div class="px-6 lg:px-8 py-6">
            <div v-if="result.queryType === 1" class="space-y-4">
              <div class="flex items-start space-x-3">
                <div class="w-2 h-2 bg-indigo-500 rounded-full mt-2 flex-shrink-0"></div>
                <div>
                    <div class="flex">
                        <h4 class="font-semibold text-gray-800 mb-1"><a href="https://www.data.go.kr/data/15013115/standard.do" 
                     target="_blank">ì „êµ­ì „ê¸°ì°¨ì¶©ì „ì†Œí‘œì¤€ë°ì´í„°</a></h4>
                        <a href="https://www.data.go.kr/data/15013115/standard.do" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="inline-flex items-center gap-3 text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                            <span class="ml-2">ğŸ”—</span>
                        </a>
                    </div>
                <!-- <p class="text-sm text-gray-600 mb-2">ì „êµ­ì˜ ì „ê¸°ì°¨ ì¶©ì „ì†Œ ìœ„ì¹˜ ë° ìš´ì˜ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ê³µê³µë°ì´í„°</p> -->
                </div>
              </div>
            </div>
            
            <div v-else-if="result.queryType === 2" class="space-y-4">
              <div class="flex items-start space-x-3">
                <div class="w-2 h-2 bg-emerald-500 rounded-full mt-2 flex-shrink-0"></div>
                <div class="flex">
                  <h4 class="font-semibold text-gray-800 mb-1">ì§€ì—­ë³„ ì†Œë“ ë°ì´í„°</h4>
                      <a href="https://www.data.go.kr/data/15082063/fileData.do" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-3 text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                          <span class="ml-2">ğŸ”—</span>
                        </a>
                  <!-- <p class="text-sm text-gray-600 mb-2">í†µê³„ì²­ ë° ê´€ë ¨ ê¸°ê´€ì—ì„œ ì œê³µí•˜ëŠ” ì§€ì—­ë³„ í‰ê· ì†Œë“ í†µê³„ ì •ë³´</p> -->
                </div>
              </div>
            </div>

            <div v-else-if="result.queryType === 3" class="space-y-4">
              <div class="flex items-start space-x-3">
                <div class="flex">
                  <!-- <div class="w-2 h-2 bg-emerald-500 rounded-full mt-2 flex-shrink-0"></div> -->
                  <h4 class="font-semibold text-gray-800 mb-1">ì „êµ­ë²„ìŠ¤ì •ë¥˜ì¥ìœ„ì¹˜ë°ì´í„°</h4>
                      <a href="https://www.data.go.kr/data/15067528/fileData.do" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-3 text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                          <span class="ml-2">ğŸ”—</span>
                        </a>
                  <!-- <p class="text-sm text-gray-600 mb-2">í†µê³„ì²­ ë° ê´€ë ¨ ê¸°ê´€ì—ì„œ ì œê³µí•˜ëŠ” ì§€ì—­ë³„ í‰ê· ì†Œë“ í†µê³„ ì •ë³´</p> -->
                </div>

                <div class="flex">
                  <!-- <div class="w-2 h-2 bg-emerald-500 rounded-full mt-2 flex-shrink-0"></div> -->
                  <h4 class="font-semibold text-gray-800 mb-1">ì „êµ­ë³µì§€ìˆ˜ê¸‰ë°ì´í„°</h4>
                      <a href="https://www.data.go.kr/data/15067528/fileData.do" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-3 text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                          <span class="ml-2">ğŸ”—</span>
                        </a>
                  <!-- <p class="text-sm text-gray-600 mb-2">í†µê³„ì²­ ë° ê´€ë ¨ ê¸°ê´€ì—ì„œ ì œê³µí•˜ëŠ” ì§€ì—­ë³„ í‰ê· ì†Œë“ í†µê³„ ì •ë³´</p> -->
                </div>

                <div class="flex">
                  <!-- <div class="w-2 h-2 bg-emerald-500 rounded-full mt-2 flex-shrink-0"></div> -->
                  <h4 class="font-semibold text-gray-800 mb-1">í–‰ì •êµ¬ì—­í‘œì¤€ë°ì´í„°(ì¸êµ¬ìˆ˜, ë©´ì )</h4>
                      <a href="https://www.data.go.kr/data/15067528/fileData.do" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-3 text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                          <span class="ml-2">ğŸ”—</span>
                        </a>
                  <!-- <p class="text-sm text-gray-600 mb-2">í†µê³„ì²­ ë° ê´€ë ¨ ê¸°ê´€ì—ì„œ ì œê³µí•˜ëŠ” ì§€ì—­ë³„ í‰ê· ì†Œë“ í†µê³„ ì •ë³´</p> -->
                </div>
              </div>
            </div>
          
            <div v-else-if="result.queryType === 4" class="space-y-4">
              <div class="flex items-start space-x-3">
                <div class="w-2 h-2 bg-purple-500 rounded-full mt-2 flex-shrink-0"></div>
                <div>
                  <h4 class="font-semibold text-gray-800 mb-1">ë³µì§€ ìˆ˜ê¸‰ ë° êµí†µ ë°ì´í„°</h4>
                  <p class="text-sm text-gray-600 mb-2">ë³´ê±´ë³µì§€ë¶€, êµ­í† êµí†µë¶€ ë“±ì—ì„œ ì œê³µí•˜ëŠ” ë³µì§€ ìˆ˜ê¸‰ í˜„í™© ë° ëŒ€ì¤‘êµí†µ ì¸í”„ë¼ ì •ë³´</p>
                  <div class="text-sm text-gray-500">
                    <span>ğŸ›ï¸</span>
                    <span class="ml-1">ë³´ê±´ë³µì§€ë¶€, êµ­í† êµí†µë¶€, ì§€ìì²´ ê³µê³µë°ì´í„° í™œìš©</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ê³µí†µ ë©”ì‹œì§€ -->
            <!-- <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
              <div class="flex items-start space-x-2">
                <span class="text-gray-500 text-sm mt-0.5">â„¹ï¸</span>
                <div class="text-sm text-gray-600">
                  <p class="font-medium mb-1">ë°ì´í„° í’ˆì§ˆ ë° ìµœì‹ ì„±</p>
                  <p>ëª¨ë“  ë°ì´í„°ëŠ” ê³µê³µê¸°ê´€ì—ì„œ ê³µì‹ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ë©°, ì •ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤. ë‹¨, ë°ì´í„° ìˆ˜ì§‘ ì‹œì ì— ë”°ë¼ ìµœì‹  ì •ë³´ì™€ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
              </div>
            </div> -->
          </div>
        </div>

        <!-- Error State -->
        <div v-if="result && !result.success" class="bg-red-50 border border-red-200 rounded-2xl p-8 shadow-lg">
          <h3 class="font-semibold text-red-800 mb-3 text-lg flex items-center">
            <span class="mr-2">âš ï¸</span>
            ì˜¤ë¥˜ ë°œìƒ
          </h3>
          <p class="text-red-600">{{ result.error }}</p>
        </div>
      </div>

    </div>

    <!-- Footer -->
    <div class="bg-white/90 backdrop-blur-xl shadow-sm border-t border-gray-100/80 mt-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div>
            <h4 class="text-sm font-normal text-gray-500 mb-2">ì§€ì‹ê·¸ë˜í”„ ì—”ì§„</h4>
            <p class="text-xs text-gray-400">Shannon Knowledge Graph</p>
          </div>
          <div>
            <h4 class="text-sm font-normal text-gray-500 mb-2">ë¬¸ì˜</h4>
            <p class="text-xs text-gray-400">hike.cau@gmail.com</p>
          </div>
          <div>
            <h4 class="text-sm font-normal text-gray-500 mb-2">ì—…ë°ì´íŠ¸</h4>
            <p class="text-xs text-gray-400">2025ë…„ 9ì›”</p>
          </div>
        </div>
        <div class="mt-10">
            <p class="mt-10 text-xs text-gray-400 text-center">Â© 2025 Shannon Insight - Advanced Knowledge Graph Analytics</p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, nextTick, watch, onUnmounted, onMounted } from 'vue'
// ë³µì§€ ì°¨íŠ¸ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€
const hasWelfareChartData = computed(() => {
  if (result.value?.queryType !== 3) return false
  const regions = result.value?.data?.welfare_analysis?.regions
  if (regions && Array.isArray(regions) && regions.length > 0) return true
  if (result.value?.results && Array.isArray(result.value.results) && result.value.results.length > 0) return true
  return false
})

const userQuery = ref('')
const result = ref(null)
const loading = ref(false)
const showQuery = ref(false)
const chartCanvas = ref(null)
const pieChartCanvas = ref(null)
const mapContainer = ref(null)
const welfareLineChart = ref(null)
const welfareBarChart = ref(null)
const topChartCanvas = ref(null)
const bottomChartCanvas = ref(null)
const welfareChartType = ref('line')
const isAdvancedQuery = ref(false)
const currentTipIndex = ref(0)

// ë³µí•© ì¶”ë¡  ì§„í–‰ ìƒíƒœ ê´€ë¦¬
const complexReasoningProgress = ref({
  isActive: false,
  currentStep: 0,
  totalSteps: 3,
  stepTitle: '',
  stepDescription: ''
})

let currentChart = null
let currentPieChart = null
let currentWelfareLineChart = null
let currentWelfareBarChart = null
let currentTopChart = null
let currentBottomChart = null
let currentMap = null
let currentTileLayer = null
const currentMapStyle = ref('openstreetmap')

// const API_BASE_URL = 'http://localhost:8001/api'

const config = useRuntimeConfig()
const API_BASE_URL = config.public.apiUrl

const mapStyleOptions = {
  openstreetmap: {
    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    attribution: 'Â© OpenStreetMap contributors',
    name: 'OSM'
  },
  cartodb: {
    url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
    attribution: 'Â© OpenStreetMap contributors Â© CARTO',
    name: 'Light'
  }
}

const sampleQueries = [
  { title: 'ì „ê¸°ì°¨ ì¶©ì „ì†Œ', query: 'ì„œìš¸íŠ¹ë³„ì‹œ ë™ì‘êµ¬ì˜ ì „ê¸°ì°¨ ì¶©ì „ì†Œ ìœ„ì¹˜ë¥¼ í™•ì¸í•´ì¤˜', difficulty: 'basic' },
  { title: 'ì†Œë“ ë¶„í¬', query: 'ì§€ì—­ë³„ ì†Œë“ ë¶„í¬ í˜„í™©ì„ ë¶„ì„í•´ì¤˜', difficulty: 'basic' },
  { title: 'ë³µì§€ìˆ˜ê¸‰ + ë²„ìŠ¤ì •ë¥˜ì¥', query: 'ë©´ì  ëŒ€ë¹„ ë²„ìŠ¤ì •ë¥˜ì¥ ìˆ˜ì™€ ë³µì§€ìˆ˜ê¸‰ì ìˆ˜ì˜ ë¹„ìœ¨ì´ ë‚®ì€ ì§€ì—­ì€ ì–´ë””ì•¼?', difficulty: 'advanced' }
]

const analysisTips = [
  {
    title: 'êµ¬ì²´ì ì¸ ì§ˆë¬¸í•˜ê¸°',
    description: '"ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì „ê¸°ì°¨ ì¶©ì „ì†Œ í˜„í™©"ì²˜ëŸ¼ êµ¬ì²´ì ìœ¼ë¡œ ì§ˆë¬¸í•˜ë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    icon: 'search',
    example: 'ì˜ˆ: "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì „ê¸°ì°¨ ì¶©ì „ì†Œ í˜„í™©"'
  },
  {
    title: 'ì—°ê´€ì„± ì°¾ê¸°',
    description: '"ì†Œë“ê³¼ êµí†µì‹œì„¤ ê´€ê³„"ì²˜ëŸ¼ ë‘ ë°ì´í„° ê°„ì˜ ê´€ê³„ë¥¼ ì§ˆë¬¸í•˜ë©´ í¥ë¯¸ë¡œìš´ ì¸ì‚¬ì´íŠ¸ë¥¼ ë°œê²¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    icon: 'chart',
    example: 'ì˜ˆ: "ì†Œë“ê³¼ êµí†µì‹œì„¤ ê´€ê³„"'
  },
  {
    title: 'íŠ¸ë Œë“œ ë¶„ì„',
    description: '"ìµœê·¼ 3ë…„ê°„ ë³€í™” ì¶”ì´"ë‚˜ "ì§€ì—­ë³„ ë¹„êµ"ì™€ ê°™ì€ ì‹œê°„/ê³µê°„ ê´€ì ì˜ ì§ˆë¬¸ë„ ìœ ìš©í•©ë‹ˆë‹¤.',
    icon: 'trend',
    example: 'ì˜ˆ: "ìµœê·¼ 3ë…„ê°„ ë³€í™” ì¶”ì´"'
  }
]

// ìë™ ìŠ¬ë¼ì´ë” ë¡œì§
let tipSliderInterval = null

const startTipSlider = () => {
  tipSliderInterval = setInterval(() => {
    currentTipIndex.value = (currentTipIndex.value + 1) % analysisTips.length
  }, 4000)
}

const stopTipSlider = () => {
  if (tipSliderInterval) {
    clearInterval(tipSliderInterval)
    tipSliderInterval = null
  }
}

// onMounted ì¶”ê°€ (ê¸°ì¡´ í•¨ìˆ˜ë“¤ ë’¤ì—)
if (process.client) {
  startTipSlider()
}

// ë‚˜ë¨¸ì§€ computed propertiesì™€ functionsëŠ” ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼í•˜ê²Œ ìœ ì§€
const tableColumns = computed(() => {
  if (!result.value?.results?.length) return []
  
  if (result.value.queryType === 3) {
    if (result.value.data?.welfare_analysis?.regions?.length) {
      const sampleRow = result.value.data.welfare_analysis.regions[0]
      return Object.keys(sampleRow)
    }
    
    if (result.value.results?.length) {
      return Object.keys(result.value.results[0])
    }
    
    return ['ì§€ì—­ëª…', 'ë©´ì ', 'ë³µì§€ìˆ˜ê¸‰ììˆ˜', 'ë²„ìŠ¤ì •ë¥˜ì¥ìˆ˜', 'ë³µì§€ë°€ë„', 'ë²„ìŠ¤ë°€ë„', 'ì¢…í•©ì ìˆ˜']
  }
  
  return Object.keys(result.value.results[0])
})

const displayResults = computed(() => {
  if (!result.value?.results) return []
  
  if (result.value.queryType === 3) {
    if (result.value.data?.welfare_analysis?.regions?.length) {
      return result.value.data.welfare_analysis.regions.slice(0, 5)
    }
  }
  
  return result.value.results.slice(0, 5)
})

const shouldShowMap = computed(() => {
  if (result.value?.queryType !== 1 || !result.value.results?.length) {
    return false
  }
  
  const firstResult = result.value.results[0]
  const hasCoords = firstResult?.ìœ„ë„ && firstResult?.ê²½ë„
  return hasCoords
})

const shouldShowBarChart = computed(() => {
  // queryTypeë§Œ í™•ì¸í•˜ê³ , ë¡œë”© ì¤‘ì´ê±°ë‚˜ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
  return result.value?.queryType && [2].includes(result.value.queryType) && 
         (loading.value || (result.value.results?.length > 0))
})

const shouldShowAdvancedChart = computed(() => {
  return result.value?.queryType === 4 && result.value.data?.districts?.length > 0
})

const shouldShowScatterChart = computed(() => {
  return result.value?.queryType === 4 && 
         (loading.value || (result.value.data?.districts?.length > 0))
})

const shouldShowPieChart = computed(() => {
  return false
})

const analysisKeywords = computed(() => {
  return result.value?.keywords || []
})

const formattedAnalysis = computed(() => {
  if (!result.value?.analysis) return ''
  return result.value.analysis
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
})

const formatCellValue = (value) => {
  if (value === null || value === undefined || value === '') return '-'
  
  if (typeof value === 'number' || (typeof value === 'string' && !isNaN(parseFloat(value)))) {
    const num = parseFloat(value)
    
    if (isNaN(num)) return String(value)
    
    if (num % 1 !== 0) {
      return num.toFixed(2)
    }
    
    return num.toLocaleString()
  }
  
  return String(value)
}

const executeQuery = async () => {
  if (!userQuery.value.trim()) return
  
  isAdvancedQuery.value = sampleQueries.some(sample => 
    sample.difficulty === 'advanced' && userQuery.value.includes(sample.title.split(' ')[0])
  ) || userQuery.value.includes('ë¹„ìœ¨') || userQuery.value.includes('ë³µí•©') || userQuery.value.includes('ì¶”ë¡ ')
  
  loading.value = true
  result.value = null
  welfareChartType.value = 'line'
  destroyCharts()
  
  complexReasoningProgress.value = {
    isActive: false,
    currentStep: 0,
    totalSteps: 3,
    stepTitle: '',
    stepDescription: ''
  }
  
  try {
    const queryType = determineQueryType(userQuery.value)
    
    if (queryType === 3) {
      complexReasoningProgress.value.isActive = true
      await simulateComplexReasoningSteps()
    }
    
    const response = await fetch(`${API_BASE_URL}/query/analyze`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        query: userQuery.value,
        queryType: queryType
      })
    })
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    
    const data = await response.json()
    
    result.value = {
      success: data.success,
      queryType: data.queryType,
      sparqlQuery: data.sparqlQuery,
      data: data.data,
      results: data.results,
      analysis: data.analysis,
      keywords: data.keywords || [],
      reasoningSteps: isAdvancedQuery.value ? generateReasoningSteps(data.queryType) : null,
      error: data.success ? null : data.message
    }

    if (data.success && data.results?.length) {
      // Query2ì˜ ê²½ìš° íŠ¹ë³„í•œ ì²˜ë¦¬
      if (data.queryType === 2) {
        console.log('Query2 detected, preparing for chart rendering...')
        
        // DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸°
        await nextTick()
        
        // ì¶”ê°€ ì•ˆì •í™” ëŒ€ê¸°
        await new Promise(resolve => setTimeout(resolve, 400))
        
        console.log('Starting chart drawing for Query2...')
      } else {
        await nextTick()
      }
      
      await drawChart()
    }
    
  } catch (err) {
    console.error('Query execution error:', err)
    result.value = { 
      success: false, 
      error: `ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`
    }
  } finally {
    loading.value = false
    complexReasoningProgress.value.isActive = false
  }
}


const debugCanvasState = () => {
  console.log('=== Canvas Debug Info ===')
  console.log('shouldShowBarChart:', shouldShowBarChart.value)
  console.log('topChartCanvas exists:', !!topChartCanvas.value)
  console.log('bottomChartCanvas exists:', !!bottomChartCanvas.value)
  
  if (topChartCanvas.value) {
    const topRect = topChartCanvas.value.getBoundingClientRect()
    console.log('topCanvas size:', topRect.width, 'x', topRect.height)
    console.log('topCanvas connected:', topChartCanvas.value.isConnected)
  }
  
  if (bottomChartCanvas.value) {
    const bottomRect = bottomChartCanvas.value.getBoundingClientRect()
    console.log('bottomCanvas size:', bottomRect.width, 'x', bottomRect.height)
    console.log('bottomCanvas connected:', bottomChartCanvas.value.isConnected)
  }
  
  console.log('currentTopChart:', !!currentTopChart)
  console.log('currentBottomChart:', !!currentBottomChart)
  console.log('========================')
}

const executeAdvancedQuery = async () => {
  loading.value = true
  destroyCharts()

  // ë³µì§€ ë¶„ì„ ì§„í–‰ ìƒíƒœ ì„¤ì • (query3)
  complexReasoningProgress.value = {
    isActive: true,
    currentStep: 0,
    totalSteps: 3,
    stepTitle: '',
    stepDescription: ''
  }

  try {
    await simulateComplexReasoningSteps()

    const response = await fetch(`${API_BASE_URL}/query/analyze`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: 'ë³µì§€ ì·¨ì•½ì„± ë¶„ì„',
        queryType: 3
      })
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    const data = await response.json()

    result.value = {
      success: data.success,
      queryType: data.queryType,
      sparqlQuery: data.sparqlQuery,
      data: data.data,
      results: data.results,
      analysis: data.analysis,
      keywords: data.keywords || [],
      reasoningSteps: generateReasoningSteps(3),
      error: data.success ? null : data.message
    }

    if (data.success && data.results?.length) {
      await nextTick()
      await drawChart()
    }

  } catch (err) {
    console.error('ë³µì§€ ë¶„ì„ ì‹¤í–‰ ì˜¤ë¥˜:', err)
    result.value = {
      success: false,
      error: `ë³µì§€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`
    }
  } finally {
    loading.value = false
    complexReasoningProgress.value.isActive = false
  }
}

// ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ë„ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€í•˜ë˜, ì—¬ê¸°ì„œëŠ” ìƒëµ
const determineQueryType = (query) => {
  const q = query.toLowerCase()
  if (q.includes('ì „ê¸°ì°¨') || q.includes('ì¶©ì „ì†Œ')) return 1
  if (q.includes('ì†Œë“') || q.includes('ê²½ì œ')) return 2
  if (q.includes('ë³µì§€') || q.includes('ìˆ˜ê¸‰')) return 3
  if (q.includes('ë²„ìŠ¤') || q.includes('ì •ë¥˜ì¥')) return 4
  return 1
}

const generateReasoningSteps = (queryType) => {
  if (queryType === 3) {
    return [
      {
        step: 1,
        title: "í–‰ì •êµ¬ì—­ ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘",
        description: "ê° ì§€ì—­ì˜ í–‰ì •êµ¬ì—­ëª…, ë©´ì , ì¸êµ¬ìˆ˜ ë“± ê¸°ë³¸ ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.",
        detail: "schema:AdministrativeAreaë¥¼ í†µí•´ ì§€ì—­ë³„ ê¸°ë³¸ ì •ë³´ë¥¼ ì¶”ì¶œ"
      },
      {
        step: 2,
        title: "ë³µì§€ìˆ˜ê¸‰ì ë°ì´í„° ì§‘ê³„",
        description: "ì§€ì—­ë³„ ë³µì§€ìˆ˜ê¸‰ì ìˆ˜ë¥¼ í•©ì‚°í•˜ì—¬ ì´ ìˆ˜ê¸‰ì ê·œëª¨ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤.",
        detail: "schema:GovernmentServiceì˜ numberOfEmployeesë¥¼ ì§€ì—­ë³„ë¡œ GROUP BY ì§‘ê³„"
      },
      {
        step: 3,
        title: "êµí†µ ì¸í”„ë¼ í˜„í™© ë¶„ì„",
        description: "ê° ì§€ì—­ì˜ ë²„ìŠ¤ì •ë¥˜ì¥ ê°œìˆ˜ë¥¼ ê³„ì‚°í•˜ì—¬ êµí†µ ì ‘ê·¼ì„±ì„ ì¸¡ì •í•©ë‹ˆë‹¤.",
        detail: "schema:BusStopì„ ì§€ì—­ë³„ë¡œ COUNTí•˜ì—¬ êµí†µ ì¸í”„ë¼ ë°€ë„ ê³„ì‚°"
      },
      {
        step: 4,
        title: "ë©´ì  ëŒ€ë¹„ ë°€ë„ ì§€í‘œ ê³„ì‚°",
        description: "ë³µì§€ìˆ˜ê¸‰ì ë°€ë„ì™€ ë²„ìŠ¤ì •ë¥˜ì¥ ë°€ë„ë¥¼ ë©´ì  ëŒ€ë¹„ë¡œ ì •ê·œí™”í•©ë‹ˆë‹¤.",
        detail: "ë³µì§€ë°€ë„ = ë³µì§€ìˆ˜ê¸‰ììˆ˜ / ë©´ì , ë²„ìŠ¤ë°€ë„ = ë²„ìŠ¤ì •ë¥˜ì¥ìˆ˜ / ë©´ì "
      },
      {
        step: 5,
        title: "ì¢…í•© ì·¨ì•½ì„± ì ìˆ˜ ì‚°ì¶œ",
        description: "ë³µì§€ ìˆ˜ìš”ëŠ” ë†’ì§€ë§Œ êµí†µ ì ‘ê·¼ì„±ì´ ë‚®ì€ ì§€ì—­ì„ ì‹ë³„í•˜ëŠ” ì¢…í•© ì ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.",
        detail: "ì¢…í•©ì ìˆ˜ = (ë³µì§€ë°€ë„ Ã— 10) - (ë²„ìŠ¤ë°€ë„ Ã— 5), ë†’ì„ìˆ˜ë¡ ì·¨ì•½"
      }
    ]
  }
  return []
}

const generateAdvancedReasoningSteps = () => {
  return [
    {
      step: 1,
      title: "ì†Œë“ ë°ì´í„° ìˆ˜ì§‘ ë° ê²€ì¦",
      description: "ì§€ì—­ë³„ í‰ê· ì†Œë“ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ë°ì´í„° í’ˆì§ˆì„ ê²€ì¦í•©ë‹ˆë‹¤.",
      detail: "schema:AdministrativeAreaì˜ amount ì†ì„±ì„ í†µí•´ ì§€ì—­ë³„ ì†Œë“ ì •ë³´ ì¶”ì¶œ"
    },
    {
      step: 2,
      title: "ì „ê¸°ì°¨ ì¶©ì „ì†Œ ìœ„ì¹˜ ë°ì´í„° ë¶„ì„",
      description: "ê° ì§€ì—­ì— ì„¤ì¹˜ëœ ì „ê¸°ì°¨ ì¶©ì „ì†Œì˜ ê°œìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.",
      detail: "schema:ElectricVehicleChargingStationì„ ì§€ì—­ë³„ë¡œ COUNTí•˜ì—¬ ì¶©ì „ì†Œ ë°€ë„ ê³„ì‚°"
    },
    {
      step: 3,
      title: "ìƒê´€ê´€ê³„ ë¶„ì„ ìˆ˜í–‰",
      description: "ì†Œë“ ìˆ˜ì¤€ê³¼ ì¶©ì „ì†Œ ê°œìˆ˜ ê°„ì˜ ìƒê´€ê´€ê³„ë¥¼ í†µê³„ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.",
      detail: "ì†Œë“ê³¼ ì¶©ì „ì†Œ ìˆ˜ì˜ í”¼ì–´ìŠ¨ ìƒê´€ê³„ìˆ˜ ê³„ì‚° ë° ìœ ì˜ì„± ê²€ì •"
    },
    {
      step: 4,
      title: "ì§€ì—­ë³„ íŒ¨í„´ ì‹ë³„",
      description: "ê³ ì†Œë“ ì§€ì—­ê³¼ ì €ì†Œë“ ì§€ì—­ì˜ ì¶©ì „ì†Œ ë¶„í¬ íŒ¨í„´ì„ ë¹„êµ ë¶„ì„í•©ë‹ˆë‹¤.",
      detail: "ì†Œë“ êµ¬ê°„ë³„ ì¶©ì „ì†Œ ë°€ë„ ì°¨ì´ ë¶„ì„ ë° í†µê³„ì  ìœ ì˜ì„± ê²€ì •"
    },
    {
      step: 5,
      title: "ì •ì±… ì¸ì‚¬ì´íŠ¸ ë„ì¶œ",
      description: "ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì „ê¸°ì°¨ ë³´ê¸‰ ì •ì±…ì— ëŒ€í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ë„ì¶œí•©ë‹ˆë‹¤.",
      detail: "ì§€ì—­ë³„ ë§ì¶¤í˜• ì¶©ì „ ì¸í”„ë¼ í™•ì¶© ë°©ì•ˆ ë° ì •ì±… ì œì–¸ ë„ì¶œ"
    }
  ]
}

// ë³µí•© ì¶”ë¡  ë‹¨ê³„ë³„ ì§„í–‰ ì‹œë®¬ë ˆì´ì…˜
const simulateComplexReasoningSteps = async () => {
  const steps = [
    {
      step: 1,
      title: "ë°ì´í„° í™•ì¸ ì¤‘",
      description: "ê´€ë ¨ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  ê²€ì¦í•©ë‹ˆë‹¤.",
      duration: 5000
    },
    {
      step: 2,
      title: "ë¶„ì„ ì§„í–‰ ì¤‘",
      description: "ë³µí•© ì¶”ë¡  ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
      duration: 10000
    },
    {
      step: 3,
      title: "ë¶„ì„ ê²°ê³¼ ì •ë¦¬ ì¤‘",
      description: "ë¶„ì„ ê²°ê³¼ë¥¼ ì •ë¦¬í•˜ê³  ì‹œê°í™”ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.",
      duration: 10000
    }
  ]

  for (let i = 0; i < steps.length; i++) {
    const step = steps[i]
    
    // í˜„ì¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸
    complexReasoningProgress.value.currentStep = step.step
    complexReasoningProgress.value.stepTitle = step.title
    complexReasoningProgress.value.stepDescription = step.description
    
    // ê° ë‹¨ê³„ë§ˆë‹¤ ì§€ì •ëœ ì‹œê°„ë§Œí¼ ëŒ€ê¸°
    await new Promise(resolve => setTimeout(resolve, step.duration))
  }
}

// ê³ ê¸‰ ë¶„ì„ ë‹¨ê³„ë³„ ì§„í–‰ ì‹œë®¬ë ˆì´ì…˜ (query4ìš©)
const simulateAdvancedReasoningSteps = async () => {
  const steps = [
    {
      step: 1,
      title: "ì†Œë“ ë°ì´í„° ìˆ˜ì§‘ ì¤‘",
      description: "ì§€ì—­ë³„ ì†Œë“ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ê²€ì¦í•©ë‹ˆë‹¤.",
      duration: 3000
    },
    {
      step: 2,
      title: "ì¶©ì „ì†Œ ë°ì´í„° ë¶„ì„ ì¤‘",
      description: "ì „ê¸°ì°¨ ì¶©ì „ì†Œ ìœ„ì¹˜ ë°ì´í„°ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.",
      duration: 4000
    },
    {
      step: 3,
      title: "ìƒê´€ê´€ê³„ ê³„ì‚° ì¤‘",
      description: "ì†Œë“ê³¼ ì¶©ì „ì†Œ ê°„ì˜ ìƒê´€ê´€ê³„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.",
      duration: 5000
    },
    {
      step: 4,
      title: "ê²°ê³¼ ì •ë¦¬ ì¤‘",
      description: "ë¶„ì„ ê²°ê³¼ë¥¼ ì •ë¦¬í•˜ê³  ì¸ì‚¬ì´íŠ¸ë¥¼ ë„ì¶œí•©ë‹ˆë‹¤.",
      duration: 3000
    }
  ]

  for (let i = 0; i < steps.length; i++) {
    const step = steps[i]
    
    // í˜„ì¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸
    complexReasoningProgress.value.currentStep = step.step
    complexReasoningProgress.value.stepTitle = step.title
    complexReasoningProgress.value.stepDescription = step.description
    
    // ê° ë‹¨ê³„ë§ˆë‹¤ ì§€ì •ëœ ì‹œê°„ë§Œí¼ ëŒ€ê¸°
    await new Promise(resolve => setTimeout(resolve, step.duration))
  }
}

const loadSampleQuery = (index) => {
  if (index >= 0 && index < sampleQueries.length) {
    userQuery.value = sampleQueries[index].query
  }
}

const refreshPage = () => {
  window.location.reload()
}

const clearResults = () => {
  result.value = null
  userQuery.value = ''
  showQuery.value = false
  destroyCharts()
}

const destroyCharts = () => {
  if (currentChart) {
    currentChart.destroy()
    currentChart = null
  }
  if (currentPieChart) {
    currentPieChart.destroy()
    currentPieChart = null
  }
  if (currentWelfareLineChart) {
    currentWelfareLineChart.destroy()
    currentWelfareLineChart = null
  }
  if (currentWelfareBarChart) {
    currentWelfareBarChart.destroy()
    currentWelfareBarChart = null
  }
  if (currentTopChart) {
    currentTopChart.destroy()
    currentTopChart = null
  }
  if (currentBottomChart) {
    currentBottomChart.destroy()
    currentBottomChart = null
  }
  if (currentMap) {
    currentMap.remove()
    currentMap = null
  }
  currentTileLayer = null
}

// 4. drawChart í•¨ìˆ˜ì—ì„œ query2 íŠ¹ë³„ ì²˜ë¦¬
const drawChart = async () => {
  if (!result.value?.results?.length) {
    console.log('No results available for chart drawing')
    return
  }

  try {
    const queryType = result.value.queryType
    console.log(`Drawing chart for queryType: ${queryType}`)

    if (queryType === 1 && shouldShowMap.value) {
      await drawMap()
    } else if (queryType === 2) {
      // Query2ì˜ ê²½ìš° ë” ì‹ ì¤‘í•œ ì²˜ë¦¬
      console.log('Preparing for Query2 income charts...')
      
      const { Chart, registerables } = await import('chart.js')
      Chart.register(...registerables)
      
      // DOM ì™„ì „ ì¤€ë¹„ ëŒ€ê¸° (ë” ê¸¸ê²Œ)
      await nextTick()
      await new Promise(resolve => setTimeout(resolve, 300))
      
      // shouldShowBarChartê°€ trueì¸ì§€ ì¬í™•ì¸
      if (!shouldShowBarChart.value) {
        console.log('Bar chart should not be shown, skipping...')
        return
      }
      
      await drawIncomeCharts(Chart)
      
    } else if (queryType === 3) {
      const { Chart, registerables } = await import('chart.js')
      Chart.register(...registerables)
      
      // DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸°
      await nextTick()
      await new Promise(resolve => setTimeout(resolve, 300))
      
      await drawWelfareCharts(Chart)
    } else if (queryType === 4) {
      const { Chart, registerables } = await import('chart.js')
      Chart.register(...registerables)
      await drawScatterChart(Chart)
    }
  } catch (error) {
    console.error('Chart drawing error:', error)
    
    // í•œ ë²ˆë§Œ ì¬ì‹œë„
    if (!error.retried && result.value?.queryType === 2) {
      error.retried = true
      console.log('Retrying chart drawing in 1 second...')
      setTimeout(() => drawChart(), 1000)
    }
  }
}

// ë³µì§€ ë¶„ì„ìš© ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ì§„ë‹¨ ë¡œê·¸ ì¶”ê°€)
const drawWelfareCharts = async (Chart, retryCount = 0) => {
  if (result.value?.queryType !== 3) {
    console.log(`ë³µì§€ ì°¨íŠ¸ëŠ” query3ì—ì„œë§Œ ê·¸ë¦½ë‹ˆë‹¤. í˜„ì¬ queryType: ${result.value?.queryType}`)
    return
  }

  // ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ ì§„ë‹¨
  const regions = result.value?.data?.welfare_analysis?.regions
  const fallbackResults = result.value?.results
  console.log('[drawWelfareCharts] ë°ì´í„° ì§„ë‹¨:', {
    regionsType: typeof regions,
    regionsLen: Array.isArray(regions) ? regions.length : 'N/A',
    fallbackResultsLen: Array.isArray(fallbackResults) ? fallbackResults.length : 'N/A',
    welfareLineChartRef: !!welfareLineChart.value,
    welfareBarChartRef: !!welfareBarChart.value,
    welfareChartType: welfareChartType.value
  })

  if (!hasWelfareChartData.value) {
    console.warn('[drawWelfareCharts] ì‹œê°í™”í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.')
    return
  }

  try {
    // DOMì´ ì™„ì „íˆ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
    await nextTick()
    await new Promise(resolve => setTimeout(resolve, 200))
    // welfareChartTypeì— ë”°ë¼ í•´ë‹¹ ì°¨íŠ¸ë§Œ ê·¸ë¦¬ê¸°
    if (welfareChartType.value === 'line') {
      await drawWelfareLineChart(Chart)
    } else if (welfareChartType.value === 'bar') {
      await drawWelfareBarChart(Chart)
    } else {
      // í˜¹ì‹œ ëª¨ë¥¼ í™•ì¥ ëŒ€ë¹„
      await drawWelfareLineChart(Chart)
      await new Promise(resolve => setTimeout(resolve, 100))
      await drawWelfareBarChart(Chart)
    }
  } catch (error) {
    console.error('ë³µì§€ ì°¨íŠ¸ ê·¸ë¦¬ê¸° ì˜¤ë¥˜:', error)
    // ì¬ì‹œë„ ë¡œì§ (ìµœëŒ€ 2ë²ˆ)
    if (retryCount < 2) {
      console.log(`ë³µì§€ ì°¨íŠ¸ ì¬ì‹œë„ ì¤‘... (${retryCount + 1}/2)`)
      await new Promise(resolve => setTimeout(resolve, 500))
      await drawWelfareCharts(Chart, retryCount + 1)
    }
  }
}

// welfareChartTypeì´ ë°”ë€” ë•Œë§ˆë‹¤ ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¼
watch(welfareChartType, async (newType, oldType) => {
  if (result.value?.queryType === 3 && hasWelfareChartData.value) {
    const { Chart, registerables } = await import('chart.js')
    Chart.register(...registerables)
    await nextTick()
    await drawWelfareCharts(Chart)
  }
})

// ë³µì§€ ì§€ì—­ë³„ í˜„í™© ë¼ì¸ ì°¨íŠ¸
const drawWelfareLineChart = async (Chart) => {
  // query3ì—ì„œë§Œ ì‹¤í–‰ë˜ë„ë¡ ì œí•œ
  if (result.value?.queryType !== 3) {
    console.log('welfareLineChartëŠ” query3ì—ì„œë§Œ ê·¸ë¦½ë‹ˆë‹¤.')
    return
  }

  // Canvas refê°€ ì¡´ì¬í•˜ëŠ”ì§€ ë¨¼ì € í™•ì¸
  if (!welfareLineChart.value) {
    console.warn('welfareLineChart refê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. DOMì— ë Œë”ë§ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
    return
  }

  // Canvas ì¤€ë¹„ ìƒíƒœ í™•ì¸
  const canvasReady = await waitForCanvasReady(welfareLineChart, 'WelfareLineChart')
  if (!canvasReady) {
    console.warn('welfareLineChart canvasê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤')
    return
  }

  // ê¸°ì¡´ ì°¨íŠ¸ ì •ë¦¬
  if (currentWelfareLineChart) {
    currentWelfareLineChart.destroy()
    currentWelfareLineChart = null
  }

  try {
    const ctx = welfareLineChart.value.getContext('2d')
    
    // ë°ì´í„° ì†ŒìŠ¤ ê²°ì • (ë°±ì—”ë“œ ì²˜ë¦¬ ë°ì´í„° ìš°ì„ )
    let regions = []
    if (result.value.data?.welfare_analysis?.regions?.length) {
      regions = result.value.data.welfare_analysis.regions.slice(0, 8)
      console.log('ë°±ì—”ë“œ ì²˜ë¦¬ ë°ì´í„° ì‚¬ìš©:', regions.length, 'ê°œ ì§€ì—­')
    } else if (result.value.results?.length) {
      regions = result.value.results.slice(0, 8)
      console.log('ì›ë³¸ SPARQL ê²°ê³¼ ì‚¬ìš©:', regions.length, 'ê°œ ì§€ì—­')
    } else {
      console.warn('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤')
      return
    }

    // ë°ì´í„° ì¶”ì¶œ ë° ì•ˆì „í•œ ë³€í™˜
    const labels = regions.map(r => {
      const name = r.ì§€ì—­ëª… || r.region || 'ì•Œ ìˆ˜ ì—†ìŒ'
      return String(name).length > 10 ? String(name).substring(0, 10) + '...' : String(name)
    })
    
    const areaData = regions.map(r => {
      const area = parseFloat(r.ë©´ì  || r.area || 0)
      return isNaN(area) ? 0 : area
    })
    
    const welfareData = regions.map(r => {
      const welfare = parseInt(r.ë³µì§€ìˆ˜ê¸‰ììˆ˜ || r.welfare_count || 0)
      return isNaN(welfare) ? 0 : welfare
    })
    
    const busData = regions.map(r => {
      const bus = parseInt(r.ë²„ìŠ¤ì •ë¥˜ì¥ìˆ˜ || r.bus_count || 0)
      return isNaN(bus) ? 0 : bus
    })
    
    console.log('ì°¨íŠ¸ ë°ì´í„° í™•ì¸:', {
      labels: labels.length,
      areas: areaData.filter(v => v > 0).length,
      welfare: welfareData.filter(v => v > 0).length,
      bus: busData.filter(v => v > 0).length
    })

    currentWelfareLineChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'ë©´ì  (kmÂ²)',
            data: areaData,
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            yAxisID: 'y'
          },
          {
            label: 'ë³µì§€ìˆ˜ê¸‰ììˆ˜ (ëª…)',
            data: welfareData,
            borderColor: '#F59E0B',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            yAxisID: 'y1'
          },
          {
            label: 'ë²„ìŠ¤ì •ë¥˜ì¥ìˆ˜ (ê°œ)',
            data: busData,
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: { size: 12, weight: '500' },
              color: '#374151',
              usePointStyle: true,
              padding: 15
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              label: function(context) {
                const value = context.parsed.y
                const label = context.dataset.label
                
                if (label.includes('ë©´ì ')) {
                  return `${label}: ${value.toFixed(2)}`
                } else {
                  return `${label}: ${value.toLocaleString()}`
                }
              }
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              color: '#6B7280',
              font: { size: 10 },
              maxRotation: 45
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'ë©´ì  (kmÂ²)',
              color: '#10B981',
              font: { size: 11, weight: 'bold' }
            },
            ticks: {
              color: '#10B981',
              font: { size: 10 },
              callback: function(value) {
                return value.toFixed(1)
              }
            },
            grid: { color: '#F3F4F6' }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'ìˆ˜ëŸ‰ (ëª…/ê°œ)',
              color: '#F59E0B',
              font: { size: 11, weight: 'bold' }
            },
            ticks: {
              color: '#F59E0B',
              font: { size: 10 },
              callback: function(value) {
                return value.toLocaleString()
              }
            },
            grid: { drawOnChartArea: false }
          }
        }
      }
    })
  } catch (error) {
    console.error('ë³µì§€ ë¼ì¸ ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error)
  }
}

// drawWelfareBarChart í•¨ìˆ˜ ìˆ˜ì • (ê¸°ì¡´ í•¨ìˆ˜ êµì²´)
const drawWelfareBarChart = async (Chart) => {
  // query3ì—ì„œë§Œ ì‹¤í–‰ë˜ë„ë¡ ì œí•œ
  if (result.value?.queryType !== 3) {
    console.log('welfareBarChartëŠ” query3ì—ì„œë§Œ ê·¸ë¦½ë‹ˆë‹¤.')
    return
  }

  // Canvas refê°€ ì¡´ì¬í•˜ëŠ”ì§€ ë¨¼ì € í™•ì¸
  if (!welfareBarChart.value) {
    console.warn('welfareBarChart refê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. DOMì— ë Œë”ë§ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
    return
  }

  // Canvas ì¤€ë¹„ ìƒíƒœ í™•ì¸
  const canvasReady = await waitForCanvasReady(welfareBarChart, 'WelfareBarChart')
  if (!canvasReady) {
    console.warn('welfareBarChart canvasê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤')
    return
  }

  // ê¸°ì¡´ ì°¨íŠ¸ ì •ë¦¬
  if (currentWelfareBarChart) {
    currentWelfareBarChart.destroy()
    currentWelfareBarChart = null
  }

  try {
    const ctx = welfareBarChart.value.getContext('2d')
    
    // ë°ì´í„° ì†ŒìŠ¤ ê²°ì •
    let regions = []
    if (result.value.data?.welfare_analysis?.regions?.length) {
      regions = result.value.data.welfare_analysis.regions.slice(0, 10)
      console.log('ë°±ì—”ë“œ ì²˜ë¦¬ ë°ì´í„°ë¡œ ë°” ì°¨íŠ¸ ìƒì„±:', regions.length, 'ê°œ ì§€ì—­')
    } else if (result.value.results?.length) {
      regions = result.value.results.slice(0, 10)
      console.log('ì›ë³¸ SPARQL ê²°ê³¼ë¡œ ë°” ì°¨íŠ¸ ìƒì„±:', regions.length, 'ê°œ ì§€ì—­')
    } else {
      console.warn('ë°” ì°¨íŠ¸ìš© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤')
      return
    }

    const labels = regions.map(r => {
      const name = r.ì§€ì—­ëª… || r.region || 'ì•Œ ìˆ˜ ì—†ìŒ'
      return String(name).length > 8 ? String(name).substring(0, 8) + '...' : String(name)
    })
    
    // í…Œì´ë¸”ì— í‘œì‹œë˜ëŠ” ì ìˆ˜ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì¶”ê°€ ì •ê·œí™” ì—†ìŒ)
    const scores = regions.map(r => {
      let score = 0
      
      // ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬ëœ ì •ê·œí™”ì ìˆ˜ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
      if (r.ì •ê·œí™”ì ìˆ˜ !== undefined && r.ì •ê·œí™”ì ìˆ˜ !== null) {
        score = parseFloat(r.ì •ê·œí™”ì ìˆ˜)
        console.log(`${r.ì§€ì—­ëª…}: ì •ê·œí™”ì ìˆ˜ ì‚¬ìš© = ${score}`)
      }
      // ì •ê·œí™”ì ìˆ˜ê°€ ì—†ìœ¼ë©´ ì¢…í•©ì ìˆ˜ ì‚¬ìš©
      else if (r.ì¢…í•©ì ìˆ˜ !== undefined && r.ì¢…í•©ì ìˆ˜ !== null) {
        score = parseFloat(r.ì¢…í•©ì ìˆ˜)
        console.log(`${r.ì§€ì—­ëª…}: ì¢…í•©ì ìˆ˜ ì‚¬ìš© = ${score}`)
      }
      // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ 0
      else {
        score = 0
        console.log(`${r.ì§€ì—­ëª…}: ì ìˆ˜ ì—†ìŒ, 0ìœ¼ë¡œ ì„¤ì •`)
      }
      
      return isNaN(score) ? 0 : score
    })
    
    // *** ì¤‘ìš”: ì¶”ê°€ ì •ê·œí™” ì œê±° - ë°±ì—”ë“œì—ì„œ ê³„ì‚°ëœ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš© ***
    const finalScores = scores
    
    console.log('ìµœì¢… ì°¨íŠ¸ ì ìˆ˜ (ì •ê·œí™” ì—†ìŒ):', finalScores)
    
    // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ê²°ì •
    const colors = finalScores.map(score => {
      if (score >= 80) return '#DC2626' // ë†’ì€ ì·¨ì•½ì„± - ë¹¨ê°„ìƒ‰
      if (score >= 60) return '#F59E0B' // ì¤‘ê°„ ì·¨ì•½ì„± - ì£¼í™©ìƒ‰
      if (score >= 40) return '#10B981' // ë³´í†µ - ì´ˆë¡ìƒ‰
      return '#6B7280' // ë‚®ì€ ì·¨ì•½ì„± - íšŒìƒ‰
    })

    console.log('ë°” ì°¨íŠ¸ ë°ì´í„° í™•ì¸:', {
      labels: labels,
      scores: finalScores,
      colors: colors.slice(0, 3)
    })

    currentWelfareBarChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'ë³µì§€ ì·¨ì•½ì„± ì ìˆ˜',
          data: finalScores,  // ë°±ì—”ë“œ ê³„ì‚°ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          backgroundColor: colors,
          borderColor: colors,
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                const score = context.parsed.y
                let level = ''
                if (score >= 80) level = 'ë†’ì€ ì·¨ì•½ì„±'
                else if (score >= 60) level = 'ì¤‘ê°„ ì·¨ì•½ì„±'
                else if (score >= 40) level = 'ë³´í†µ'
                else level = 'ë‚®ì€ ì·¨ì•½ì„±'
                
                return `${context.dataset.label}: ${score.toFixed(1)}ì  (${level})`
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            // max ê°’ì„ ë™ì ìœ¼ë¡œ ì„¤ì • (ì •ê·œí™”ì ìˆ˜ë©´ 100, ì¢…í•©ì ìˆ˜ë©´ ìë™)
            max: finalScores.some(s => s > 100) ? undefined : 100,
            title: {
              display: true,
              text: 'ì·¨ì•½ì„± ì ìˆ˜',
              color: '#374151',
              font: { size: 12, weight: 'bold' }
            },
            ticks: {
              color: '#6B7280',
              font: { size: 11 },
              callback: function(value) {
                return value.toFixed(0) + 'ì '
              }
            },
            grid: { color: '#F3F4F6' }
          },
          x: {
            ticks: {
              color: '#6B7280',
              font: { size: 10 },
              maxRotation: 45,
              minRotation: 0
            },
            grid: { display: false }
          }
        }
      }
    })
  } catch (error) {
    console.error('ë³µì§€ ë°” ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error)
  }
}

const destroyWelfareCharts = () => {
  if (currentWelfareLineChart) {
    currentWelfareLineChart.destroy()
    currentWelfareLineChart = null
  }
  if (currentWelfareBarChart) {
    currentWelfareBarChart.destroy()
    currentWelfareBarChart = null
  }
}

// ê³ ê¸‰ ë¶„ì„ ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ì†Œë“ê³¼ ì¶©ì „ì†Œ ìƒê´€ê´€ê³„)
const drawAdvancedChart = async (Chart) => {
  if (!chartCanvas.value) {
    console.warn('chartCanvas refê°€ ì—†ìŠµë‹ˆë‹¤')
    return
  }

  // ê¸°ì¡´ ì°¨íŠ¸ ì •ë¦¬
  if (currentChart) {
    currentChart.destroy()
    currentChart = null
  }

  try {
    const ctx = chartCanvas.value.getContext('2d')
    
    // ê³ ê¸‰ ë¶„ì„ ë°ì´í„° ì¶”ì¶œ
    const districts = result.value.data?.districts || []
    const correlation = result.value.data?.correlation || 0
    
    if (districts.length === 0) {
      console.warn('ê³ ê¸‰ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤')
      return
    }

    // ìƒìœ„ 10ê°œ ì§€ì—­ë§Œ í‘œì‹œ
    const topDistricts = districts.slice(0, 10)
    
    const labels = topDistricts.map(d => {
      const name = d.name || 'ì•Œ ìˆ˜ ì—†ìŒ'
      return String(name).length > 8 ? String(name).substring(0, 8) + '...' : String(name)
    })
    
    const incomes = topDistricts.map(d => d.income || 0)
    const stations = topDistricts.map(d => d.chargerCount || 0)
    
    console.log('ê³ ê¸‰ ë¶„ì„ ì°¨íŠ¸ ë°ì´í„°:', {
      labels: labels.length,
      incomes: incomes.filter(v => v > 0).length,
      stations: stations.filter(v => v > 0).length,
      correlation: correlation
    })

    currentChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'í‰ê· ì†Œë“ (ë§Œì›)',
            data: incomes,
            backgroundColor: '#10B981',
            borderRadius: 8,
            borderColor: '#ffffff',
            borderWidth: 2,
            borderSkipped: false,
            yAxisID: 'y'
          },
          {
            label: 'ì¶©ì „ì†Œ ìˆ˜ (ê°œ)',
            data: stations,
            backgroundColor: '#8B5CF6',
            borderRadius: 8,
            borderColor: '#ffffff',
            borderWidth: 2,
            borderSkipped: false,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: {
                size: 13,
                weight: '500'
              },
              color: '#374151',
              usePointStyle: true,
              padding: 20
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              label: function(context) {
                const value = context.parsed.y
                const label = context.dataset.label
                
                if (label.includes('ì†Œë“')) {
                  return `${label}: ${value.toLocaleString()}ë§Œì›`
                } else {
                  return `${label}: ${value}ê°œ`
                }
              }
            },
            title: {
              display: true,
              text: `ìƒê´€ê³„ìˆ˜: ${correlation.toFixed(3)} (${correlation > 0.5 ? 'ê°•í•œ ì–‘ì˜ ìƒê´€ê´€ê³„' : correlation > 0.3 ? 'ì¤‘ê°„ ìƒê´€ê´€ê³„' : 'ì•½í•œ ìƒê´€ê´€ê³„'})`,
              color: '#374151',
              font: {
                size: 14,
                weight: 'bold'
              },
              padding: 20
            }
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'í‰ê· ì†Œë“ (ë§Œì›)',
              color: '#10B981',
              font: { size: 12, weight: 'bold' }
            },
            ticks: {
              color: '#10B981',
              font: { size: 11 },
              callback: function(value) {
                return value.toLocaleString() + 'ë§Œì›'
              }
            },
            grid: { color: '#F3F4F6' }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'ì¶©ì „ì†Œ ìˆ˜ (ê°œ)',
              color: '#8B5CF6',
              font: { size: 12, weight: 'bold' }
            },
            ticks: {
              color: '#8B5CF6',
              font: { size: 11 },
              callback: function(value) {
                return value + 'ê°œ'
              }
            },
            grid: { drawOnChartArea: false }
          },
          x: {
            ticks: {
              color: '#6B7280',
              font: { size: 10 },
              maxRotation: 45,
              minRotation: 0
            },
            grid: { display: false }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    })
  } catch (error) {
    console.error('ê³ ê¸‰ ë¶„ì„ ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error)
  }
}

// 2. Canvas ì¡´ì¬ ë° ì¤€ë¹„ ìƒíƒœ í™•ì¸ ê°œì„ 
const waitForCanvasReady = async (canvasRef, refName, maxAttempts = 20) => {
  let attempts = 0
  
  console.log(`waitForCanvasReady ì‹œì‘: ${refName}, í˜„ì¬ queryType: ${result.value?.queryType}`)
  
  while (attempts < maxAttempts) {
    // 1ë‹¨ê³„: refê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    if (!canvasRef.value) {
      console.log(`${refName}: Canvas ref not found (attempt ${attempts + 1})`)
      await new Promise(resolve => setTimeout(resolve, 150))
      attempts++
      continue
    }
    
    // 2ë‹¨ê³„: DOMì— ì‹¤ì œë¡œ ë§ˆìš´íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (!canvasRef.value.isConnected) {
      console.log(`${refName}: Canvas not connected to DOM (attempt ${attempts + 1})`)
      await new Promise(resolve => setTimeout(resolve, 100))
      attempts++
      continue
    }
    
    // 3ë‹¨ê³„: í¬ê¸°ê°€ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
    const rect = canvasRef.value.getBoundingClientRect()
    if (rect.width === 0 || rect.height === 0) {
      console.log(`${refName}: Canvas size not ready: ${rect.width}x${rect.height} (attempt ${attempts + 1})`)
      await new Promise(resolve => setTimeout(resolve, 100))
      attempts++
      continue
    }
    
    // 4ë‹¨ê³„: getContextê°€ ê°€ëŠ¥í•œì§€ í™•ì¸
    try {
      const ctx = canvasRef.value.getContext('2d')
      if (!ctx) {
        console.log(`${refName}: Cannot get 2D context (attempt ${attempts + 1})`)
        await new Promise(resolve => setTimeout(resolve, 100))
        attempts++
        continue
      }
    } catch (error) {
      console.log(`${refName}: Context error: ${error.message} (attempt ${attempts + 1})`)
      await new Promise(resolve => setTimeout(resolve, 100))
      attempts++
      continue
    }
    
    // 5ë‹¨ê³„: ì¶”ê°€ ì•ˆì •í™” ëŒ€ê¸°
    await new Promise(resolve => setTimeout(resolve, 50))
    
    console.log(`${refName}: Canvas ready after ${attempts + 1} attempts`)
    return true
  }
  
  console.error(`${refName}: Canvas not ready after ${maxAttempts} attempts`)
  return false
}


// ì†Œë“ ë¶„í¬ ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ìƒìœ„ 10ê°œ, í•˜ìœ„ 10ê°œ ë¶„ë¦¬)
// 2. ê°œì„ ëœ ì†Œë“ ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜
const drawIncomeCharts = async (Chart) => {
  if (!result.value?.results?.length) {
    console.log('No results available for income charts')
    return
  }

  console.log('Starting income charts creation...')

  try {
    // ê¸°ì¡´ ì°¨íŠ¸ ì •ë¦¬
    await destroyIncomeChartsAndWait()
    
    // ë°ì´í„° ì¤€ë¹„
    const chartData = prepareIncomeChartData()
    if (!chartData) {
      console.error('Failed to prepare chart data')
      return
    }
    
    console.log('Chart data prepared:', {
      topRegions: chartData.topRegions.length,
      bottomRegions: chartData.bottomRegions.length,
      yAxisMax: chartData.yAxisMax
    })
    
    // Canvas ìš”ì†Œë“¤ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
    const topReady = await waitForCanvasReady(topChartCanvas, 'TopChart')
    const bottomReady = await waitForCanvasReady(bottomChartCanvas, 'BottomChart')
    
    if (!topReady || !bottomReady) {
      console.error('Canvas elements not ready for chart creation')
      
      // ì¬ì‹œë„ ë¡œì§
      console.log('Attempting retry in 500ms...')
      setTimeout(() => {
        if (result.value?.results?.length && shouldShowBarChart.value) {
          drawIncomeCharts(Chart)
        }
      }, 500)
      return
    }

    console.log('Both canvas elements ready, creating charts...')
    
    // ì°¨íŠ¸ ìƒì„±ì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
    await createTopChart(Chart, chartData)
    await new Promise(resolve => setTimeout(resolve, 100))
    await createBottomChart(Chart, chartData)
    
    console.log('Income charts created successfully')
    
  } catch (error) {
    console.error('Income charts creation error:', error)
    
    // ì—ëŸ¬ ë°œìƒ ì‹œ ì¬ì‹œë„
    setTimeout(() => {
      if (result.value?.results?.length && shouldShowBarChart.value) {
        console.log('Retrying chart creation after error...')
        drawIncomeCharts(Chart)
      }
    }, 1000)
  }
}


// 3. ì°¨íŠ¸ ì •ë¦¬ ë° ëŒ€ê¸° í•¨ìˆ˜
const destroyIncomeChartsAndWait = async () => {
  if (currentTopChart) {
    currentTopChart.destroy()
    currentTopChart = null
  }
  if (currentBottomChart) {
    currentBottomChart.destroy()
    currentBottomChart = null
  }
  
  // DOM ì •ë¦¬ ì™„ë£Œë¥¼ ìœ„í•œ ëŒ€ê¸°
  await new Promise(resolve => setTimeout(resolve, 150))
}

// 4. ë°ì´í„° ì¤€ë¹„ í•¨ìˆ˜ ë¶„ë¦¬
const prepareIncomeChartData = () => {
  try {
    const sortedData = result.value.results
      .map(r => ({
        region: r.ì§€ì—­ëª… || 'ì•Œ ìˆ˜ ì—†ìŒ',
        income: parseInt(r.í‰ê· ì†Œë“ || r.income || 0) || 0
      }))
      .filter(d => d.income > 0) // ìœ íš¨í•œ ë°ì´í„°ë§Œ
      .sort((a, b) => b.income - a.income)

    if (sortedData.length === 0) {
      console.warn('No valid income data available')
      return null
    }

    const maxIncome = Math.max(...sortedData.map(d => d.income))
    const yAxisMax = Math.ceil(maxIncome * 1.1)

    const topRegions = sortedData.slice(0, 10)
    const bottomRegions = sortedData.slice(-10).reverse()

    return {
      topRegions,
      bottomRegions,
      yAxisMax,
      totalDataPoints: sortedData.length
    }
  } catch (error) {
    console.error('Data preparation error:', error)
    return null
  }
}

// 5. ìƒìœ„ ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
const createTopChart = async (Chart, chartData) => {
  if (!topChartCanvas.value) return

  const ctx = topChartCanvas.value.getContext('2d')
  if (!ctx) {
    console.error('Failed to get 2D context for top chart')
    return
  }

  // Context ìƒíƒœ í™•ì¸
  ctx.clearRect(0, 0, topChartCanvas.value.width, topChartCanvas.value.height)

  const commonOptions = getCommonChartOptions(chartData.yAxisMax)

  currentTopChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: chartData.topRegions.map(d => {
        const name = d.region
        return name.length > 8 ? name.substring(0, 8) + '...' : name
      }),
      datasets: [{
        label: 'í‰ê· ì†Œë“ (ë§Œì›)',
        data: chartData.topRegions.map(d => d.income),
        backgroundColor: '#10B981',
        borderRadius: 8,
        borderColor: '#ffffff',
        borderWidth: 2,
        borderSkipped: false,
      }]
    },
    options: {
      ...commonOptions,
      plugins: {
        ...commonOptions.plugins,
        title: {
          display: false
        }
      }
    }
  })

  console.log('Top chart created successfully')
}

// 6. í•˜ìœ„ ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
const createBottomChart = async (Chart, chartData) => {
  if (!bottomChartCanvas.value) return

  const ctx = bottomChartCanvas.value.getContext('2d')
  if (!ctx) {
    console.error('Failed to get 2D context for bottom chart')
    return
  }

  // Context ìƒíƒœ í™•ì¸
  ctx.clearRect(0, 0, bottomChartCanvas.value.width, bottomChartCanvas.value.height)

  const commonOptions = getCommonChartOptions(chartData.yAxisMax)

  currentBottomChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: chartData.bottomRegions.map(d => {
        const name = d.region
        return name.length > 8 ? name.substring(0, 8) + '...' : name
      }),
      datasets: [{
        label: 'í‰ê· ì†Œë“ (ë§Œì›)',
        data: chartData.bottomRegions.map(d => d.income),
        backgroundColor: '#F59E0B',
        borderRadius: 8,
        borderColor: '#ffffff',
        borderWidth: 2,
        borderSkipped: false,
      }]
    },
    options: {
      ...commonOptions,
      plugins: {
        ...commonOptions.plugins,
        title: {
          display: false
        }
      }
    }
  })

  console.log('Bottom chart created successfully')
}

// 7. ê³µí†µ ì°¨íŠ¸ ì˜µì…˜
const getCommonChartOptions = (yAxisMax) => ({
  responsive: true,
  maintainAspectRatio: false,
  animation: {
    duration: 1000,
    easing: 'easeOutCubic'
  },
  plugins: {
    legend: {
      display: false
    },
    tooltip: {
      backgroundColor: 'rgba(0, 0, 0, 0.8)',
      titleColor: '#ffffff',
      bodyColor: '#ffffff',
      borderColor: '#374151',
      borderWidth: 1,
      cornerRadius: 8,
      callbacks: {
        label: function(context) {
          return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}ë§Œì›`
        }
      }
    }
  },
  scales: {
    y: {
      beginAtZero: true,
      max: yAxisMax,
      grid: {
        color: '#F3F4F6',
        drawBorder: false
      },
      ticks: {
        color: '#6B7280',
        font: { size: 11 },
        callback: function(value) {
          return value.toLocaleString() + 'ë§Œì›'
        }
      }
    },
    x: {
      grid: { display: false },
      ticks: {
        color: '#6B7280',
        font: { size: 10 },
        maxRotation: 45,
        minRotation: 0
      }
    }
  },
  interaction: {
    intersect: false,
    mode: 'index'
  }
})


// query4 ì‚°ì ë„ ì°¨íŠ¸
const drawScatterChart = async (Chart) => {
  // query4ì—ì„œë§Œ ì‹¤í–‰ë˜ë„ë¡ ì œí•œ
  if (result.value?.queryType !== 4) {
    console.log('scatterChartëŠ” query4ì—ì„œë§Œ ê·¸ë¦½ë‹ˆë‹¤.')
    return
  }

  if (!chartCanvas.value) {
    console.warn('chartCanvas refê°€ ì—†ìŠµë‹ˆë‹¤')
    return
  }

  // ê¸°ì¡´ ì°¨íŠ¸ ì •ë¦¬
  if (currentChart) {
    currentChart.destroy()
    currentChart = null
  }

  try {
    const ctx = chartCanvas.value.getContext('2d')
    
    // Query 4 ë°ì´í„° ì¶”ì¶œ
    const districts = result.value.data?.districts || []
    const correlation = result.value.data?.correlation || {}
    
    if (districts.length === 0) {
      console.warn('ì‚°ì ë„ìš© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤')
      return
    }

    console.log('ì‚°ì ë„ ë°ì´í„° í™•ì¸:', {
      districts: districts.length,
      correlation: correlation.coefficient,
      sampleData: districts.slice(0, 3)
    })

    // ì‚°ì ë„ ë°ì´í„° í¬ì¸íŠ¸ ìƒì„±
    const scatterData = districts.map(d => ({
      x: d.income || 0,           // Xì¶•: ì†Œë“
      y: d.chargerCount || 0,     // Yì¶•: ì¶©ì „ì†Œ ìˆ˜ (ë°±ì—”ë“œ í•„ë“œëª…ê³¼ ì¼ì¹˜)
      label: d.name || 'ì•Œ ìˆ˜ ì—†ìŒ'
    })).filter(point => point.x > 0 && point.y > 0) // ìœ íš¨í•œ ë°ì´í„°ë§Œ

    console.log('ì‚°ì ë„ í¬ì¸íŠ¸:', scatterData.slice(0, 3))

    // ì¶”ì„¸ì„  ê³„ì‚°
    let trendlineData = []
    if (scatterData.length > 1) {
      const x = scatterData.map(d => d.x)
      const y = scatterData.map(d => d.y)
      
      const n = x.length
      const meanX = x.reduce((a, b) => a + b, 0) / n
      const meanY = y.reduce((a, b) => a + b, 0) / n
      
      let numerator = 0
      let denominator = 0
      
      for (let i = 0; i < n; i++) {
        numerator += (x[i] - meanX) * (y[i] - meanY)
        denominator += (x[i] - meanX) ** 2
      }
      
      if (denominator !== 0) {
        const slope = numerator / denominator
        const intercept = meanY - slope * meanX
        
        const minX = Math.min(...x)
        const maxX = Math.max(...x)
        
        trendlineData = [
          { x: minX, y: slope * minX + intercept },
          { x: maxX, y: slope * maxX + intercept }
        ]
        
        console.log('ì¶”ì„¸ì„  ê³„ì‚° ì™„ë£Œ:', { slope, intercept, points: trendlineData })
      }
    }

    // ì°¨íŠ¸ ìƒì„±
    const datasets = [
      {
        label: 'ì§€ì—­ë³„ ì†Œë“-ì¶©ì „ì†Œ ë¶„í¬',
        data: scatterData,
        backgroundColor: 'rgba(99, 102, 241, 0.7)',
        borderColor: 'rgba(99, 102, 241, 1)',
        pointRadius: 8,
        pointHoverRadius: 12,
        pointBorderWidth: 2,
        pointBorderColor: '#ffffff'
      }
    ]

    // ì¶”ì„¸ì„ ì´ ìˆìœ¼ë©´ ì¶”ê°€
    if (trendlineData.length > 0) {
      datasets.push({
        type: 'line',
        label: `ì¶”ì„¸ì„  (r=${(correlation.coefficient || 0).toFixed(3)})`,
        data: trendlineData,
        borderColor: '#EF4444', // ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        borderWidth: 4, // ê¸°ì¡´ 3ì—ì„œ 4ë¡œ ì¦ê°€
        fill: false,
        pointRadius: 0,
        pointHoverRadius: 0,
        tension: 0,
        order: 1
      })
    }

    currentChart = new Chart(ctx, {
      type: 'scatter',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 1.5,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: { size: 12, weight: '500' },
              color: '#374151',
              usePointStyle: true,
              padding: 15
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              title: function(context) {
                if (context.length > 0) {
                  const point = context[0].raw
                  return point.label || 'ì§€ì—­'
                }
                return ''
              },
              label: function(context) {
                const point = context.raw
                if (context.dataset.label.includes('ì¶”ì„¸ì„ ')) {
                  return null // ì¶”ì„¸ì„  íˆ´íŒì€ ìˆ¨ê¹€
                }
                return [
                  `í‰ê· ì†Œë“: ${point.x.toLocaleString()}ë§Œì›`,
                  `ì¶©ì „ì†Œ ìˆ˜: ${point.y}ê°œ`
                ]
              },
              afterBody: function() {
                const corr = correlation.coefficient || 0
                const strength = correlation.strength || 'ì•Œ ìˆ˜ ì—†ìŒ'
                return `\nìƒê´€ê³„ìˆ˜: ${corr.toFixed(3)} (${strength})`
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'í‰ê· ì†Œë“ (ë§Œì›)',
              color: '#374151',
              font: { size: 13, weight: 'bold' }
            },
            ticks: {
              color: '#6B7280',
              font: { size: 11 },
              callback: function(value) {
                return value.toLocaleString() + 'ë§Œì›'
              }
            },
            grid: { color: '#F3F4F6' }
          },
          y: {
            title: {
              display: true,
              text: 'ì „ê¸°ì°¨ ì¶©ì „ì†Œ ìˆ˜ (ê°œ)',
              color: '#374151',
              font: { size: 13, weight: 'bold' }
            },
              max: 200,
              ticks: {
                color: '#6B7280',
                font: { size: 11 },
                stepSize: 50, // í•œ ì¹¸ì˜ í¬ê¸°ë¥¼ 50ìœ¼ë¡œ ì„¤ì •
                callback: function(value) {
                  return value + 'ê°œ'
                }
              },
              grid: { color: '#F3F4F6' }
          }
        },
        interaction: {
          intersect: false,
          mode: 'point'
        }
      }
    })

    console.log('ì‚°ì ë„ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ')

  } catch (error) {
    console.error('ì‚°ì ë„ ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error)
  }
}

// ê²°ê³¼ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
watch(() => result.value?.results, async (newResults) => {
  if (newResults?.length) {
    await nextTick()
    await drawChart()
  }
})

// ë³µì§€ ì°¨íŠ¸ íƒ€ì…ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
watch(() => welfareChartType.value, async (newType) => {
  if (result.value?.queryType === 3 && result.value?.results?.length) {
    // ì°¨íŠ¸ê°€ ì´ë¯¸ ê·¸ë ¤ì ¸ ìˆìœ¼ë¯€ë¡œ íƒ€ì… ë³€ê²½ë§Œ ì²˜ë¦¬
    console.log(`ë³µì§€ ì°¨íŠ¸ íƒ€ì… ë³€ê²½: ${newType}`)
  }
})

const drawMap = async () => {
  destroyCharts()
  
  // DOMì´ ì™„ì „íˆ ë Œë”ë§ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
  await nextTick()
  
  // mapContainerê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
  let attempts = 0
  while (!mapContainer.value && attempts < 10) {
    await new Promise(resolve => setTimeout(resolve, 100))
    attempts++
  }
  
  if (!mapContainer.value) {
    console.log('Map container not ready after 10 attempts')
    return
  }

  try {
    const L = await import('leaflet')
    
    // Leaflet CSSë„ ë™ì ìœ¼ë¡œ ë¡œë“œ
    if (!document.querySelector('link[href*="leaflet"]')) {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'
      document.head.appendChild(link)
    }

    // SVG ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜
    const createSVGIcon = (color = '#4F46E5') => {
      const svgString = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="${color}" stroke="white" stroke-width="2"/>
          <circle cx="12" cy="9" r="2.5" fill="white"/>
        </svg>
      `
      
      return L.divIcon({
        html: svgString,
        className: 'custom-svg-icon',
        iconSize: [24, 24],
        iconAnchor: [12, 24],
        popupAnchor: [0, -24]
      })
    }

    // CSS ìŠ¤íƒ€ì¼ ì¶”ê°€ (ê·¸ë¦¼ì íš¨ê³¼)
    if (!document.querySelector('#leaflet-svg-styles')) {
      const style = document.createElement('style')
      style.id = 'leaflet-svg-styles'
      style.textContent = `
        .custom-svg-icon {
          background: none !important;
          border: none !important;
          filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
      `
      document.head.appendChild(style)
    }

    // ì²« ë²ˆì§¸ ì¶©ì „ì†Œ ìœ„ì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ ìƒì„±
    const firstStation = result.value.results[2]
    const centerLat = parseFloat(firstStation.ìœ„ë„) || 37.5665
    const centerLng = parseFloat(firstStation.ê²½ë„) || 126.9780

    currentMap = L.map(mapContainer.value).setView([centerLat, centerLng], 13)

    // ê¸°ë³¸ ìŠ¤íƒ€ì¼ë¡œ OpenStreetMap ì‚¬ìš©
    const selectedStyle = mapStyleOptions.openstreetmap
    currentTileLayer = L.tileLayer(selectedStyle.url, {
      attribution: selectedStyle.attribution
    }).addTo(currentMap)

    // ì¶©ì „ì†Œ ë§ˆì»¤ ì¶”ê°€
    let markerCount = 0
    result.value.results.forEach((station, index) => {
      const lat = parseFloat(station.ìœ„ë„)
      const lng = parseFloat(station.ê²½ë„)
      
      if (!isNaN(lat) && !isNaN(lng)) {
        const iconColor = '#4F46E5'
        const customIcon = createSVGIcon(iconColor)
        
        const marker = L.marker([lat, lng], { icon: customIcon }).addTo(currentMap)
        markerCount++
        
        // íŒì—… ë‚´ìš© ìƒì„±
        const popupContent = `
          <div class="p-2">
            <h3 class="font-bold text-sm mb-1">${station.ì¶©ì „ì†Œëª… || 'ì¶©ì „ì†Œ'}</h3>
            <p class="text-xs text-gray-600 mb-1">${station.ì£¼ì†Œ || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</p>
          </div>
        `
        
        marker.bindPopup(popupContent)
      }
    })

    console.log(`Added ${markerCount} markers to map`)

  } catch (error) {
    console.error('Map creation error:', error)
  }
}

// ë³µì§€(3) ë¶„ì„ ì‹¤í–‰ ë° ê²°ê³¼ ë°˜ì˜ í•¨ìˆ˜
const onClickExecuteAdvancedQuery = async () => {
  if (loading.value) return
  
  // ì‚¬ìš©ì ì¿¼ë¦¬ë„ ì—…ë°ì´íŠ¸
  userQuery.value = 'ì§€ì—­ë³„ ì†Œë“ê³¼ ì „ê¸°ì°¨ ì¶©ì „ì†Œ ê°œìˆ˜ì˜ ìƒê´€ê´€ê³„ë¥¼ ë¶„ì„í•´ì¤˜'
  
  loading.value = true
  destroyCharts()
  
  // ê³ ê¸‰ ë¶„ì„ ì§„í–‰ ìƒíƒœ ì„¤ì • (query4 - ì†Œë“ê³¼ ì¶©ì „ì†Œ ìƒê´€ê´€ê³„)
  complexReasoningProgress.value = {
    isActive: true,
    currentStep: 0,
    totalSteps: 4,
    stepTitle: '',
    stepDescription: ''
  }

  try {
    await simulateAdvancedReasoningSteps()

    const response = await fetch(`${API_BASE_URL}/query/analyze/advanced`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: 'ì§€ì—­ë³„ ì†Œë“ê³¼ ì „ê¸°ì°¨ ì¶©ì „ì†Œ ê°œìˆ˜ì˜ ìƒê´€ê´€ê³„ë¥¼ ë¶„ì„í•´ì¤˜',
        queryType: 4
      })
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    const data = await response.json()

    result.value = {
      success: data.success,
      queryType: data.queryType,
      sparqlQuery: data.sparqlQuery,
      data: data.data,
      results: data.results,
      analysis: data.analysis,
      keywords: data.keywords || [],
      reasoningSteps: generateAdvancedReasoningSteps(),
      error: data.success ? null : data.message
    }

    if (data.success && data.results?.length) {
      await nextTick()
      await drawChart()
    }

  } catch (err) {
    console.error('ê³ ê¸‰ ë¶„ì„ ì‹¤í–‰ ì˜¤ë¥˜:', err)
    result.value = {
      success: false,
      error: `ê³ ê¸‰ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`
    }
  } finally {
    loading.value = false
    complexReasoningProgress.value.isActive = false
  }
}


// ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì°¨íŠ¸ ì •ë¦¬
onUnmounted(() => {
  stopTipSlider()
  destroyCharts()
})
</script>

<style scoped>
.animate-spin {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.prose {
  line-height: 1.6;
}

.prose strong {
  font-weight: 600;
  color: #374151;
}
</style>