<template>
  <div class="min-h-screen bg-gradient-to-br from-slate-50 via-gray-50 to-blue-50">
    <!-- Header -->
    <div class="bg-white/90 backdrop-blur-xl shadow-sm border-b border-gray-100/80">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3 cursor-pointer group" @click="refreshPage">
            <div class="relative">
              <div class="w-10 h-10 bg-gradient-to-br from-indigo-500/80 via-purple-600/80 to-blue-500/80 rounded-2xl flex items-center justify-center shadow-lg rotate-3 transform group-hover:rotate-0 transition-transform duration-300">
                <span class="text-white font-bold text-lg">S</span>
              </div>
              <div class="absolute -top-1 -right-1 w-4 h-4 bg-gradient-to-r from-emerald-400 to-teal-500 rounded-full animate-pulse"></div>
            </div>
            <div>
              <h1 class="text-2xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent group-hover:from-indigo-600 group-hover:to-purple-600 transition-all duration-300">
                Shannon Insight
              </h1>
              <p class="text-sm text-gray-500 font-medium group-hover:text-gray-600 transition-colors duration-300">Advanced Data Intelligence Platform</p>
            </div>
          </div>
          <div class="hidden md:flex items-center space-x-2">
            <div class="px-3 py-1.5 bg-emerald-100 text-emerald-700 text-xs font-semibold rounded-full">
              Beta v1.0
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Hero Search Section -->
      <div class="relative overflow-hidden mb-8">
        <div class="absolute inset-0 bg-gradient-to-br from-slate-400/15 via-slate-500/15 to-slate-600/15 rounded-3xl transform rotate-1"></div>
        <!-- <div class="absolute inset-0 bg-gradient-to-br from-indigo-600/20 via-purple-600/20 to-pink-600/20 rounded-3xl transform rotate-1"></div> -->
        <!-- <div class="relative bg-gradient-to-br from-indigo-600 via-purple-700 to-pink-600 rounded-3xl p-6 lg:p-8 text-white shadow-2xl"> -->
          <div class="relative bg-gradient-to-br from-blue-900/70 to-purple-700/70 rounded-3xl p-6 lg:p-8 text-white shadow-2xl backdrop-blur-sm">
          <!-- Background Pattern -->
          <div class="absolute inset-0 opacity-10">
            <div class="absolute top-0 left-0 w-40 h-40 bg-white rounded-full -translate-x-20 -translate-y-20"></div>
            <div class="absolute bottom-0 right-0 w-32 h-32 bg-white rounded-full translate-x-16 translate-y-16"></div>
            <div class="absolute top-1/2 left-1/2 w-24 h-24 bg-white rounded-full -translate-x-12 -translate-y-12"></div>
          </div>
          
          <div class="relative z-10">
            <div class="text-center mb-6">
              <h2 class="text-xl lg:text-2xl font-semibold mb-3 leading-tight">
                Îç∞Ïù¥ÌÑ∞ ÏÜç Ïà®Í≤®ÏßÑ 
                <span class="bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent">Ïù∏ÏÇ¨Ïù¥Ìä∏</span>Î•º 
                Î∞úÍ≤¨ÌïòÏÑ∏Ïöî
              </h2>
              <!-- <p class="text-lg text-white/90 font-medium">ÏûêÏó∞Ïñ¥ ÏßàÎ¨∏ÏúºÎ°ú Î≥µÌï©Ï†ÅÏù∏ Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑùÏùÑ ÏàòÌñâÌï©ÎãàÎã§</p> -->
            </div>
            
            <!-- Search Input -->
            <div class="max-w-2xl mx-auto mb-6">
              <div class="relative group">
                <div class="absolute inset-0 bg-gradient-to-r from-white/20 to-white/10 rounded-2xl blur-xl group-hover:blur-2xl transition-all duration-300"></div>
                <div class="relative flex items-center">
                  <div class="flex items-center flex-1 bg-white rounded-2xl shadow-xl overflow-hidden">
                    <svg class="w-5 h-5 text-gray-400 ml-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input
                      v-model="userQuery"
                      placeholder="ÏûêÏó∞Ïñ¥Î°ú ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                      class="flex-1 px-4 py-4 text-gray-900 placeholder-gray-500 focus:outline-none text-base"
                      @keyup.enter="executeQuery"
                    />
                    <button
                      @click="executeQuery"
                      :disabled="loading || !userQuery.trim()"
                      class="m-2 flex items-center justify-center w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed group"
                    >
                      <div v-if="loading" class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
                      <svg v-else class="w-6 h-6 group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 5 7 7-7 7"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Search Tags -->
            <div class="flex flex-wrap justify-center items-center gap-3 mb-8">
              <span class="text-white/80 text-sm font-medium">Í≤ÄÏÉâÏñ¥ ÏòàÏãú:</span>
              <button 
                v-for="(query, idx) in sampleQueries" 
                :key="idx"
                @click="loadSampleQuery(idx)"
                class="group flex items-center gap-2 px-3 py-2 bg-white/20 hover:bg-white/30 rounded-full text-xs font-medium transition-all duration-200 backdrop-blur-sm border border-white/20"
              >
                <!-- <span v-if="query.title === 'Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå'">‚ö°</span> -->
                <!-- <span v-else-if="query.title === 'ÏÜåÎìù Î∂ÑÌè¨'">üìä</span> -->
                <!-- <span v-else>üîÑ</span> -->
                <span>{{ query.title }}</span>
                <span class="text-xs px-1 py-0.5 rounded text-white/70 font-medium" 
                      :class="{
                        'bg-green-500/50': query.difficulty === 'basic',
                        'bg-red-500/50': query.difficulty === 'advanced'
                      }">
                  {{ query.difficulty === 'basic' ? 'basic' : 'advanced' }}
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Analysis Tips Slider Section - First Screen Only -->
      <div v-if="!loading && !result" class="mb-12">
        <div class="relative overflow-hidden bg-white rounded-3xl shadow-sm border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-600 flex">
                <span class="text-xl mr-2">üí°</span>
                Î∂ÑÏÑù ÌåÅ
                </h3>
                <div class="flex space-x-1">
                <button
                    v-for="(tip, index) in analysisTips"
                    :key="index"
                    @click="currentTipIndex = index"
                    :class="[
                    'w-2 h-2 rounded-full transition-all duration-300',
                    currentTipIndex === index ? 'bg-indigo-500' : 'bg-gray-300'
                    ]"
                ></button>
                </div>
            </div>
            </div>
            
            <div class="relative h-56 overflow-hidden">
            <div 
                class="flex transition-transform duration-500 ease-in-out h-full"
                :style="{ transform: `translateX(-${currentTipIndex * 100}%)` }"
            >
                <div 
                v-for="(tip, index) in analysisTips" 
                :key="index"
                class="w-full flex-shrink-0 px-6 py-12 flex items-center justify-center"
                >
                <div class="text-center max-w-md">
                    <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mb-4 mx-auto shadow-lg">
                        <!-- Í≤ÄÏÉâ ÏïÑÏù¥ÏΩò -->
                        <svg v-if="tip.icon === 'search'" class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <!-- Ï∞®Ìä∏ ÏïÑÏù¥ÏΩò -->
                        <svg v-else-if="tip.icon === 'chart'" class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <!-- Ìä∏Î†åÎìú ÏïÑÏù¥ÏΩò -->
                        <svg v-else-if="tip.icon === 'trend'" class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <h4 class="font-bold text-gray-800 mb-2 text-lg text-center">{{ tip.title }}</h4>
                    <p class="text-sm text-gray-600 leading-relaxed mb-3 text-center">{{ tip.description }}</p>
                    <div class="text-xs text-gray-500 bg-gray-50 px-3 py-1 rounded-full inline-block">
                        {{ tip.example }}
                    </div>
                </div>
                </div>
            </div>
            </div>
        </div>
      </div>

      <!-- Feature Boxes Section - First Screen Only -->
      <div v-if="!loading && !result" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="group relative overflow-hidden bg-white rounded-3xl shadow-lg border border-gray-100 hover:shadow-2xl transition-all duration-500 hover:-translate-y-2">
          <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-cyan-50 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          <div class="relative p-6 text-center">
            <div class="flex flex-col items-center mb-4">
              <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mb-4 shadow-lg group-hover:scale-110 transition-transform duration-300">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-bold text-gray-800">Î≥µÌï©Ï∂îÎ°†</h3>
            </div>
            <p class="text-gray-600 text-sm leading-relaxed mb-4">
              Ïó¨Îü¨ Îç∞Ïù¥ÌÑ∞ÏÖãÏùÑ Ïó∞Í≤∞ÌïòÏó¨ Î≥µÌï©Ï†ÅÏù∏ Ìå®ÌÑ¥Í≥º Ïù∏Í≥ºÍ¥ÄÍ≥Ñ Ï∂îÎ°†
            </p>
            <div class="flex items-center justify-center text-xs text-gray-500">
              <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
              Í≥†Í∏â Î∂ÑÏÑù Í∏∞Îä•
            </div>
          </div>
        </div>

        <div class="group relative overflow-hidden bg-white rounded-3xl shadow-lg border border-gray-100 hover:shadow-2xl transition-all duration-500 hover:-translate-y-2">
          <div class="absolute inset-0 bg-gradient-to-br from-purple-50 to-pink-50 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          <div class="relative p-6 text-center">
            <div class="flex flex-col items-center mb-4">
              <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center mb-4 shadow-lg group-hover:scale-110 transition-transform duration-300">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                </svg>
              </div>
              <h3 class="text-lg font-bold text-gray-800">Îã§ÏñëÌïú Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§</h3>
            </div>
            <p class="text-gray-600 text-sm leading-relaxed mb-4">
              Í≥µÍ≥µÎç∞Ïù¥ÌÑ∞, ÌÜµÍ≥ÑÏ≤≠, ÏßÄÏûêÏ≤¥ Îì± Ïã†Î¢∞Ìï† Ïàò ÏûàÎäî Îç∞Ïù¥ÌÑ∞ Ï¥ù 1,698,462 Ìä∏Î¶¨Ìîå
            </p>
            <div class="flex items-center justify-center text-xs text-gray-500">
              <span class="w-2 h-2 bg-purple-400 rounded-full mr-2"></span>
              Ï∂úÏ≤ò Ï†úÍ≥µ
            </div>
          </div>
        </div>

        <div class="group relative overflow-hidden bg-white rounded-3xl shadow-lg border border-gray-100 hover:shadow-2xl transition-all duration-500 hover:-translate-y-2">
          <div class="absolute inset-0 bg-gradient-to-br from-emerald-50 to-teal-50 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          <div class="relative p-6 text-center">
            <div class="flex flex-col items-center mb-4">
              <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-2xl flex items-center justify-center mb-4 shadow-lg group-hover:scale-110 transition-transform duration-300">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-bold text-gray-800">Ïã§ÏãúÍ∞Ñ ÏãúÍ∞ÅÌôî</h3>
            </div>
            <p class="text-gray-600 text-sm leading-relaxed mb-4">
              Ïù∏ÌÑ∞ÎûôÌã∞Î∏å Ï∞®Ìä∏ÏôÄ ÏßÄÎèÑÎ°ú ÏßÅÍ¥ÄÏ†ÅÏù∏ Îç∞Ïù¥ÌÑ∞ ÌëúÌòÑ
            </p>
            <div class="flex items-center justify-center text-xs text-gray-500">
              <span class="w-2 h-2 bg-emerald-400 rounded-full mr-2"></span>
              Ï∞®Ìä∏, ÏßÄÎèÑ ÏãúÍ∞ÅÌôî
            </div>
          </div>
        </div>

      </div>

      <!-- Loading State -->
      <div v-if="loading" class="text-center py-16">
        <!-- Î≥µÌï© Ï∂îÎ°† ÏßÑÌñâ ÏÉÅÌÉú (query3) -->
        <div v-if="complexReasoningProgress.isActive" class="max-w-2xl mx-auto">
          <div class="bg-white rounded-2xl shadow-xl border border-gray-200/60 p-8 mb-6">
            <div class="flex items-center justify-center mb-6">
              <div class="relative">
                <div class="w-16 h-16 border-4 border-indigo-200 rounded-full animate-spin"></div>
                <div class="absolute inset-0 w-16 h-16 border-4 border-transparent border-t-indigo-600 rounded-full animate-spin"></div>
              </div>
            </div>
            
            <h3 class="text-xl font-bold text-gray-800 mb-2">
              {{ complexReasoningProgress.stepTitle }}
            </h3>
            <p class="text-gray-600 mb-4">
              {{ complexReasoningProgress.stepDescription }}
            </p>
            
            <!-- ÏßÑÌñâÎ•† Î∞î -->
            <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
              <div 
                class="bg-gradient-to-r from-purple-500 to-indigo-600 h-2 rounded-full transition-all duration-500 ease-out"
                :style="{ width: `${(complexReasoningProgress.currentStep / complexReasoningProgress.totalSteps) * 100}%` }"
              ></div>
            </div>
            
            <p class="text-gray-500 text-sm">
              Îã®Í≥Ñ {{ complexReasoningProgress.currentStep }} / {{ complexReasoningProgress.totalSteps }}
            </p>
          </div>
        </div>
        
        <!-- ÏùºÎ∞ò Î°úÎî© ÏÉÅÌÉú -->
        <div v-else>
          <div class="relative inline-flex items-center justify-center mb-6">
            <div class="w-24 h-24 rounded-full flex items-center justify-center">
              <div class="relative">
                <div class="w-12 h-12 border-4 border-indigo-200 rounded-full animate-spin"></div>
                <div class="absolute inset-0 w-12 h-12 border-4 border-transparent border-t-indigo-600 rounded-full animate-spin"></div>
              </div>
            </div>
            <!-- <div class="absolute -inset-4 bg-gradient-to-r from-indigo-500/20 via-purple-500/20 to-pink-500/20 rounded-full blur-xl animate-pulse"></div> -->
          </div>
          <h3 class="text-xl font-semibold text-gray-800 mb-2">
            {{ isAdvancedQuery ? 'Î≥µÌï© Ï∂îÎ°†ÏùÑ ÏßÑÌñâÌïòÍ≥† ÏûàÏäµÎãàÎã§...' : 'Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§...' }}
          </h3>
          <p class="text-gray-600 max-w-md mx-auto">Ïû†ÏãúÎßå Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî</p>
        </div>
      </div>

      <!-- Results Section -->
      <div v-if="result && !loading" class="space-y-8">

        <!-- 1. Analysis Section -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
              <span class="w-8 h-8 bg-amber-100 text-amber-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">1</span>
              Î∂ÑÏÑù Í≤∞Í≥º
            </h3>
          </div>
          <div class="px-6 lg:px-8 py-8">
            <div v-if="result.analysis">
              <!-- ÌÇ§ÏõåÎìú Î∞ïÏä§ÌÉ≠ -->
              <div v-if="analysisKeywords.length > 0" class="mb-8">
                <h4 class="text-lg font-semibold text-gray-800 mb-4 flex">
                  <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold flex items-center justify-center mr-2">üìä</span>
                  ÌïµÏã¨ Ïù∏ÏÇ¨Ïù¥Ìä∏
                </h4>
                <div class="flex flex-wrap gap-3">
                  <span 
                    v-for="keyword in analysisKeywords" 
                    :key="keyword.text"
                    :class="[
                      'px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 hover:scale-105',
                      keyword.type === 'highlight' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                      keyword.type === 'number' ? 'bg-green-100 text-green-800 border border-green-200' :
                      keyword.type === 'location' ? 'bg-purple-100 text-purple-800 border border-purple-200' :
                      'bg-blue-100 text-blue-800 border border-blue-200'
                    ]"
                  >
                    {{ keyword.text }}
                  </span>
                </div>
              </div>

              <!-- ÏÉÅÏÑ∏ Î∂ÑÏÑù ÎÇ¥Ïö© -->
              <div class="prose prose-gray max-w-none">
                <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                  <span class="w-6 h-6 bg-gray-100 text-gray-600 rounded-lg text-xs font-bold flex items-center justify-center mr-2">üìù</span>
                  ÏÉÅÏÑ∏ Î∂ÑÏÑù
                </h4>
                <div v-html="formattedAnalysis" class="text-gray-700 leading-relaxed text-base bg-gray-50 rounded-xl p-6 border border-gray-200"></div>
              </div>

              <!-- Ï∂îÍ∞Ä Î∂ÑÏÑù Ï†úÏïà (query2Ïù∏ Í≤ΩÏö∞ÏóêÎßå ÌëúÏãú) -->
              <div v-if="result.queryType === 2" class="mt-8 pt-6 border-t border-gray-200">
                <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                  <span class="w-6 h-6 bg-purple-100 text-purple-600 rounded-lg text-xs font-bold flex items-center justify-center mr-2">üí°</span>
                  Ï∂îÍ∞Ä Î∂ÑÏÑù Ï†úÏïà
                </h4>
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 border border-purple-200">
                  <p class="text-gray-700 mb-4 font-medium">
                    ÏÜåÎìù Î∂ÑÌè¨ Î∂ÑÏÑùÏùÑ Î∞îÌÉïÏúºÎ°ú Îçî ÍπäÏù¥ ÏûàÎäî Ïù∏ÏÇ¨Ïù¥Ìä∏Î•º Î∞úÍ≤¨Ìï¥Î≥¥ÏÑ∏Ïöî.
                  </p>
                  <button
                    @click="onClickExecuteAdvancedQuery"
                    :disabled="loading"
                    class="group flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <div v-if="loading" class="animate-spin w-4 h-4 border-2 border-gray-500 border-t-transparent rounded-full"></div>
                    <svg v-else class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                    <span class="text-sm font-medium">ÏòàÏãú: ÏßÄÏó≠Î≥Ñ Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå Í∞úÏàòÎäî ÏÜåÎìù ÏàòÏ§ÄÍ≥º ÏÉÅÍ¥ÄÏÑ±Ïù¥ ÏûàÏùÑÍπå?</span>
                  </button>
                  <!-- <p class="text-sm text-gray-600 mt-3">
                    Í≥†Í∏â Î∂ÑÏÑùÏùÑ ÌÜµÌï¥ ÏÜåÎìùÍ≥º Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå Í∞ÑÏùò ÏÉÅÍ¥ÄÍ¥ÄÍ≥ÑÎ•º Î∂ÑÏÑùÌï©ÎãàÎã§.
                  </p> -->
                </div>
              </div>
            </div>
            <div v-else class="text-gray-500 text-center py-8">
              Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.
            </div>
          </div>
        </div>
        <!-- 2. Visualization Section -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold text-gray-800 flex items-center">
                <span class="w-8 h-8 bg-purple-100 text-purple-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">2</span>
                <span v-if="shouldShowMap">Ï∂©Ï†ÑÏÜå ÏúÑÏπò ÏßÄÎèÑ</span>
                <span v-else-if="result.queryType === 3">Î≥µÏßÄ Ï∑®ÏïΩÏÑ± Î∂ÑÏÑù</span>  
                <span v-else-if="shouldShowAdvancedChart">ÏÜåÎìùÍ≥º Ï∂©Ï†ÑÏÜå ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ Î∂ÑÏÑù</span>
                <span v-else>Îç∞Ïù¥ÌÑ∞ ÏãúÍ∞ÅÌôî</span>
              </h3>
              
              <!-- Î≥µÏßÄ Î∂ÑÏÑù Ï∞®Ìä∏ ÌÉÄÏûÖ ÏÑ†ÌÉù Î≤ÑÌäº -->
              <div v-if="result.queryType === 3" class="flex gap-2">
                <button
                  @click="welfareChartType = 'line'"
                  :class="[
                    'px-3 py-1 text-xs rounded-full transition-colors',
                    welfareChartType === 'line' 
                      ? 'bg-purple-500 text-white' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  ]"
                >
                  ÏßÄÏó≠Î≥Ñ ÌòÑÌô©
                </button>
                <button
                  @click="welfareChartType = 'bar'"
                  :class="[
                    'px-3 py-1 text-xs rounded-full transition-colors',
                    welfareChartType === 'bar' 
                      ? 'bg-purple-500 text-white' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  ]"
                >
                  Ï¢ÖÌï©Ï†êÏàò
                </button>
              </div>
            </div>
          </div>
          
          <div class="px-6 lg:px-8 py-8">
            <!-- Map for Query 1 - Charging Stations -->
            <div v-if="shouldShowMap" class="h-96 relative rounded-lg overflow-hidden border border-gray-200">
              <div ref="mapContainer" class="w-full h-full"></div>
            </div>
            
            <!-- Welfare Analysis Charts for Query 3 -->
            <div v-else-if="result.queryType === 3" class="h-96 relative">
              <!-- Line Chart for Regional Status -->
              <div v-if="welfareChartType === 'line'" class="h-full">
                <canvas ref="welfareLineChart"></canvas>
              </div>
              
              <!-- Bar Chart for Comprehensive Score -->
              <div v-else-if="welfareChartType === 'bar'" class="h-full">
                <canvas ref="welfareBarChart"></canvas>
              </div>
            </div>
            
            <!-- Bar Chart for Query 2, 4 -->
            <div v-else-if="shouldShowBarChart" class="h-[500px] relative">
              <!-- Query 2: ÏÜåÎìù Î∂ÑÌè¨ - Ï¢åÏö∞ Î∂ÑÎ¶¨Îêú Ï∞®Ìä∏ -->
              <div v-if="result.queryType === 2" class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                <!-- ÏÉÅÏúÑ 10Í∞ú ÏßÄÏó≠ -->
                <div class="bg-gray-50 rounded-xl p-4">
                  <h4 class="text-lg font-semibold text-gray-800 mb-4 text-center">ÏÉÅÏúÑ 10Í∞ú ÏßÄÏó≠</h4>
                  <div class="h-80">
                    <canvas ref="topChartCanvas"></canvas>
                  </div>
                </div>
                <!-- ÌïòÏúÑ 10Í∞ú ÏßÄÏó≠ -->
                <div class="bg-gray-50 rounded-xl p-4">
                  <h4 class="text-lg font-semibold text-gray-800 mb-4 text-center">ÌïòÏúÑ 10Í∞ú ÏßÄÏó≠</h4>
                  <div class="h-80">
                    <canvas ref="bottomChartCanvas"></canvas>
                  </div>
                </div>
              </div>
              <!-- Query 4: ÏùºÎ∞ò Î∞î Ï∞®Ìä∏ -->
              <div v-else>
                <div class="relative w-full h-[500px]">
                  <canvas ref="chartCanvas" style="width:100%;height:100%"></canvas>
                </div>
              </div>
            </div>
            
            <!-- Pie Chart for Query 3 (legacy) -->
            <div v-else-if="shouldShowPieChart" class="h-96 relative">
              <canvas ref="pieChartCanvas"></canvas>
            </div>

            <!-- No Chart Available -->
            <div v-else class="h-96 flex items-center justify-center text-gray-500">
              <div class="text-center">
                <div class="text-4xl mb-4">üìä</div>
                <p class="text-lg">ÏãúÍ∞ÅÌôîÌï† Ïàò ÏûàÎäî Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 2.5. Reasoning Steps Section (Advanced queries only) -->
        <div v-if="result.reasoningSteps?.length" class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
              <span class="w-8 h-8 bg-rose-100 text-rose-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">üß†</span>
              Ï∂îÎ°† Í≥ºÏ†ï
            </h3>
          </div>
          <div class="px-6 lg:px-8 py-8">
            <div class="space-y-6">
              <div v-for="step in result.reasoningSteps" :key="step.step" 
                   class="flex items-start space-x-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-lg flex items-center justify-center text-sm font-bold">
                  {{ step.step }}
                </div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800 mb-2">{{ step.title }}</h4>
                  <p class="text-gray-600 text-sm mb-2">{{ step.description }}</p>
                  <div class="text-xs text-gray-500 bg-white px-3 py-2 rounded-lg border">
                    <code>{{ step.detail }}</code>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 3. SPARQL Query Section -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold text-gray-800 flex items-center">
                <span class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">3</span>
                Ïã§ÌñâÎêú SPARQL ÏøºÎ¶¨
              </h3>
              <button
                @click="showQuery = !showQuery"
                class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg transition-colors text-sm font-medium"
              >
                {{ showQuery ? 'Ï†ëÍ∏∞' : 'ÌéºÏπòÍ∏∞' }}
                <span class="transform transition-transform" :class="{ 'rotate-180': showQuery }">
                  ‚ñº
                </span>
              </button>
            </div>
          </div>
          
          <div v-if="showQuery" class="px-6 lg:px-8 pb-6">
            <div class="bg-gray-900 rounded-xl p-6 overflow-x-auto">
              <pre class="text-green-400 text-sm whitespace-pre-wrap font-mono leading-relaxed">{{ result.sparqlQuery }}</pre>
            </div>
          </div>
        </div>

        <!-- 4. Results Table Section -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
              <span class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">4</span>
              ÏøºÎ¶¨ Í≤∞Í≥º ÏòàÏãú
            </h3>
          </div>
          <div v-if="tableColumns.length > 0" class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-gray-50 border-b border-gray-200">
                  <th v-for="column in tableColumns" :key="column" 
                      class="px-6 py-4 text-left font-semibold text-gray-700 text-sm">
                    {{ column }}
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(row, idx) in displayResults" :key="idx" 
                    class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                  <td v-for="column in tableColumns" :key="column" class="px-6 py-4 text-gray-600 text-sm">
                    {{ formatCellValue(row[column]) }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div v-else class="px-6 py-8 text-center text-gray-500">
            ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
          </div>
          <div v-if="result.results && result.results.length > 10" class="px-6 lg:px-8 py-4 bg-gray-50 border-t border-gray-100">
            <p class="text-sm text-gray-500">
              Ï¥ù <span class="font-semibold text-gray-700">{{ result.results.length }}Í∞ú</span> Í≤∞Í≥º Ï§ë ÏÉÅÏúÑ 5Í∞úÎßå ÌëúÏãú
            </p>
          </div>
        </div>

        <!-- 5. Data Source -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
          <div class="px-6 lg:px-8 py-6 border-b border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
              <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg text-sm font-bold flex items-center justify-center mr-3">5</span>
              Îç∞Ïù¥ÌÑ∞ Ï∂úÏ≤ò
            </h3>
          </div>

          <div class="px-6 lg:px-8 py-6">
            <div v-if="result.queryType === 1" class="space-y-4">
              <div class="flex items-start space-x-3">
                <div class="w-2 h-2 bg-indigo-500 rounded-full mt-2 flex-shrink-0"></div>
                <div>
                    <div class="flex">
                        <h4 class="font-semibold text-gray-800 mb-1"><a href="https://www.data.go.kr/data/15013115/standard.do" 
                     target="_blank">Ï†ÑÍµ≠Ï†ÑÍ∏∞Ï∞®Ï∂©Ï†ÑÏÜåÌëúÏ§ÄÎç∞Ïù¥ÌÑ∞</a></h4>
                        <a href="https://www.data.go.kr/data/15013115/standard.do" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="inline-flex items-center gap-3 text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                            <span class="ml-2">üîó</span>
                        </a>
                    </div>
                <!-- <p class="text-sm text-gray-600 mb-2">Ï†ÑÍµ≠Ïùò Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå ÏúÑÏπò Î∞è Ïö¥ÏòÅ Ï†ïÎ≥¥Î•º Ï†úÍ≥µÌïòÎäî Í≥µÍ≥µÎç∞Ïù¥ÌÑ∞</p> -->
                </div>
              </div>
            </div>
            
            <div v-else-if="result.queryType === 2" class="space-y-4">
              <div class="flex items-start space-x-3">
                <div class="w-2 h-2 bg-emerald-500 rounded-full mt-2 flex-shrink-0"></div>
                <div class="flex">
                  <h4 class="font-semibold text-gray-800 mb-1">ÏßÄÏó≠Î≥Ñ ÏÜåÎìù Îç∞Ïù¥ÌÑ∞</h4>
                      <a href="https://www.data.go.kr/data/15082063/fileData.do" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-3 text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                          <span class="ml-2">üîó</span>
                        </a>
                  <!-- <p class="text-sm text-gray-600 mb-2">ÌÜµÍ≥ÑÏ≤≠ Î∞è Í¥ÄÎ†® Í∏∞Í¥ÄÏóêÏÑú Ï†úÍ≥µÌïòÎäî ÏßÄÏó≠Î≥Ñ ÌèâÍ∑†ÏÜåÎìù ÌÜµÍ≥Ñ Ï†ïÎ≥¥</p> -->
                </div>
              </div>
            </div>

            <div v-else-if="result.queryType === 3" class="space-y-4">
              <div class="flex items-start space-x-3">
                <div class="flex">
                  <!-- <div class="w-2 h-2 bg-emerald-500 rounded-full mt-2 flex-shrink-0"></div> -->
                  <h4 class="font-semibold text-gray-800 mb-1">Ï†ÑÍµ≠Î≤ÑÏä§Ï†ïÎ•òÏû•ÏúÑÏπòÎç∞Ïù¥ÌÑ∞</h4>
                      <a href="https://www.data.go.kr/data/15067528/fileData.do" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-3 text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                          <span class="ml-2">üîó</span>
                        </a>
                  <!-- <p class="text-sm text-gray-600 mb-2">ÌÜµÍ≥ÑÏ≤≠ Î∞è Í¥ÄÎ†® Í∏∞Í¥ÄÏóêÏÑú Ï†úÍ≥µÌïòÎäî ÏßÄÏó≠Î≥Ñ ÌèâÍ∑†ÏÜåÎìù ÌÜµÍ≥Ñ Ï†ïÎ≥¥</p> -->
                </div>

                <div class="flex">
                  <!-- <div class="w-2 h-2 bg-emerald-500 rounded-full mt-2 flex-shrink-0"></div> -->
                  <h4 class="font-semibold text-gray-800 mb-1">Ï†ÑÍµ≠Î≥µÏßÄÏàòÍ∏âÎç∞Ïù¥ÌÑ∞</h4>
                      <a href="https://www.data.go.kr/data/15067528/fileData.do" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-3 text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                          <span class="ml-2">üîó</span>
                        </a>
                  <!-- <p class="text-sm text-gray-600 mb-2">ÌÜµÍ≥ÑÏ≤≠ Î∞è Í¥ÄÎ†® Í∏∞Í¥ÄÏóêÏÑú Ï†úÍ≥µÌïòÎäî ÏßÄÏó≠Î≥Ñ ÌèâÍ∑†ÏÜåÎìù ÌÜµÍ≥Ñ Ï†ïÎ≥¥</p> -->
                </div>

                <div class="flex">
                  <!-- <div class="w-2 h-2 bg-emerald-500 rounded-full mt-2 flex-shrink-0"></div> -->
                  <h4 class="font-semibold text-gray-800 mb-1">ÌñâÏ†ïÍµ¨Ïó≠ÌëúÏ§ÄÎç∞Ïù¥ÌÑ∞(Ïù∏Íµ¨Ïàò, Î©¥Ï†Å)</h4>
                      <a href="https://www.data.go.kr/data/15067528/fileData.do" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-3 text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                          <span class="ml-2">üîó</span>
                        </a>
                  <!-- <p class="text-sm text-gray-600 mb-2">ÌÜµÍ≥ÑÏ≤≠ Î∞è Í¥ÄÎ†® Í∏∞Í¥ÄÏóêÏÑú Ï†úÍ≥µÌïòÎäî ÏßÄÏó≠Î≥Ñ ÌèâÍ∑†ÏÜåÎìù ÌÜµÍ≥Ñ Ï†ïÎ≥¥</p> -->
                </div>
              </div>
            </div>
          
            <div v-else-if="result.queryType === 4" class="space-y-4">
              <div class="flex items-start space-x-3">
                <div class="w-2 h-2 bg-purple-500 rounded-full mt-2 flex-shrink-0"></div>
                <div>
                  <h4 class="font-semibold text-gray-800 mb-1">Î≥µÏßÄ ÏàòÍ∏â Î∞è ÍµêÌÜµ Îç∞Ïù¥ÌÑ∞</h4>
                  <p class="text-sm text-gray-600 mb-2">Î≥¥Í±¥Î≥µÏßÄÎ∂Ä, Íµ≠ÌÜ†ÍµêÌÜµÎ∂Ä Îì±ÏóêÏÑú Ï†úÍ≥µÌïòÎäî Î≥µÏßÄ ÏàòÍ∏â ÌòÑÌô© Î∞è ÎåÄÏ§ëÍµêÌÜµ Ïù∏ÌîÑÎùº Ï†ïÎ≥¥</p>
                  <div class="text-sm text-gray-500">
                    <span>üèõÔ∏è</span>
                    <span class="ml-1">Î≥¥Í±¥Î≥µÏßÄÎ∂Ä, Íµ≠ÌÜ†ÍµêÌÜµÎ∂Ä, ÏßÄÏûêÏ≤¥ Í≥µÍ≥µÎç∞Ïù¥ÌÑ∞ ÌôúÏö©</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Í≥µÌÜµ Î©îÏãúÏßÄ -->
            <!-- <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
              <div class="flex items-start space-x-2">
                <span class="text-gray-500 text-sm mt-0.5">‚ÑπÔ∏è</span>
                <div class="text-sm text-gray-600">
                  <p class="font-medium mb-1">Îç∞Ïù¥ÌÑ∞ ÌíàÏßà Î∞è ÏµúÏã†ÏÑ±</p>
                  <p>Î™®Îì† Îç∞Ïù¥ÌÑ∞Îäî Í≥µÍ≥µÍ∏∞Í¥ÄÏóêÏÑú Í≥µÏãùÏ†ÅÏúºÎ°ú Ï†úÍ≥µÌïòÎäî Ï†ïÎ≥¥Î•º Í∏∞Î∞òÏúºÎ°ú ÌïòÎ©∞, Ï†ïÍ∏∞Ï†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§. Îã®, Îç∞Ïù¥ÌÑ∞ ÏàòÏßë ÏãúÏ†êÏóê Îî∞Îùº ÏµúÏã† Ï†ïÎ≥¥ÏôÄ Ï∞®Ïù¥Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏäµÎãàÎã§.</p>
                </div>
              </div>
            </div> -->
          </div>
        </div>

        <!-- Error State -->
        <div v-if="result && !result.success" class="bg-red-50 border border-red-200 rounded-2xl p-8 shadow-lg">
          <h3 class="font-semibold text-red-800 mb-3 text-lg flex items-center">
            <span class="mr-2">‚ö†Ô∏è</span>
            Ïò§Î•ò Î∞úÏÉù
          </h3>
          <p class="text-red-600">{{ result.error }}</p>
        </div>
      </div>

    </div>

    <!-- Footer -->
    <div class="bg-white/90 backdrop-blur-xl shadow-sm border-t border-gray-100/80 mt-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div>
            <h4 class="text-sm font-normal text-gray-500 mb-2">ÏßÄÏãùÍ∑∏ÎûòÌîÑ ÏóîÏßÑ</h4>
            <p class="text-xs text-gray-400">Shannon Knowledge Graph</p>
          </div>
          <div>
            <h4 class="text-sm font-normal text-gray-500 mb-2">Î¨∏Ïùò</h4>
            <p class="text-xs text-gray-400">hike.cau@gmail.com</p>
          </div>
          <div>
            <h4 class="text-sm font-normal text-gray-500 mb-2">ÏóÖÎç∞Ïù¥Ìä∏</h4>
            <p class="text-xs text-gray-400">2025ÎÖÑ 9Ïõî</p>
          </div>
        </div>
        <div class="mt-10">
            <p class="mt-10 text-xs text-gray-400 text-center">¬© 2025 Shannon Insight - Advanced Knowledge Graph Analytics</p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, nextTick, watch, onUnmounted, onMounted } from 'vue'

const userQuery = ref('')
const result = ref(null)
const loading = ref(false)
const showQuery = ref(false)
const chartCanvas = ref(null)
const pieChartCanvas = ref(null)
const mapContainer = ref(null)
const welfareLineChart = ref(null)
const welfareBarChart = ref(null)
const topChartCanvas = ref(null)
const bottomChartCanvas = ref(null)
const welfareChartType = ref('line')
const isAdvancedQuery = ref(false)
const currentTipIndex = ref(0)

// Î≥µÌï© Ï∂îÎ°† ÏßÑÌñâ ÏÉÅÌÉú Í¥ÄÎ¶¨
const complexReasoningProgress = ref({
  isActive: false,
  currentStep: 0,
  totalSteps: 3,
  stepTitle: '',
  stepDescription: ''
})

let currentChart = null
let currentPieChart = null
let currentWelfareLineChart = null
let currentWelfareBarChart = null
let currentTopChart = null
let currentBottomChart = null
let currentMap = null
let currentTileLayer = null
const currentMapStyle = ref('openstreetmap')

// const API_BASE_URL = 'http://localhost:8000/api'

const config = useRuntimeConfig()
const API_BASE_URL = config.public.apiUrl

const mapStyleOptions = {
  openstreetmap: {
    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    attribution: '¬© OpenStreetMap contributors',
    name: 'OSM'
  },
  cartodb: {
    url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
    attribution: '¬© OpenStreetMap contributors ¬© CARTO',
    name: 'Light'
  }
}

const sampleQueries = [
  { title: 'Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå', query: 'ÏÑúÏö∏ÌäπÎ≥ÑÏãú ÎèôÏûëÍµ¨Ïùò Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå ÏúÑÏπòÎ•º ÌôïÏù∏Ìï¥Ï§ò', difficulty: 'basic' },
  { title: 'ÏÜåÎìù Î∂ÑÌè¨', query: 'ÏßÄÏó≠Î≥Ñ ÏÜåÎìù Î∂ÑÌè¨ ÌòÑÌô©ÏùÑ Î∂ÑÏÑùÌï¥Ï§ò', difficulty: 'basic' },
  { title: 'Î≥µÏßÄÏàòÍ∏â + Î≤ÑÏä§Ï†ïÎ•òÏû•', query: 'Î©¥Ï†Å ÎåÄÎπÑ Î≤ÑÏä§Ï†ïÎ•òÏû• ÏàòÏôÄ Î≥µÏßÄÏàòÍ∏âÏûê ÏàòÏùò ÎπÑÏú®Ïù¥ ÎÇÆÏùÄ ÏßÄÏó≠ÏùÄ Ïñ¥ÎîîÏïº?', difficulty: 'advanced' }
]

const analysisTips = [
  {
    title: 'Íµ¨Ï≤¥Ï†ÅÏù∏ ÏßàÎ¨∏ÌïòÍ∏∞',
    description: '"ÏÑúÏö∏Ïãú Í∞ïÎÇ®Íµ¨ Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå ÌòÑÌô©"Ï≤òÎüº Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú ÏßàÎ¨∏ÌïòÎ©¥ Îçî Ï†ïÌôïÌïú Î∂ÑÏÑùÏùÑ Î∞õÏùÑ Ïàò ÏûàÏäµÎãàÎã§.',
    icon: 'search',
    example: 'Ïòà: "ÏÑúÏö∏Ïãú Í∞ïÎÇ®Íµ¨ Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå ÌòÑÌô©"'
  },
  {
    title: 'Ïó∞Í¥ÄÏÑ± Ï∞æÍ∏∞',
    description: '"ÏÜåÎìùÍ≥º ÍµêÌÜµÏãúÏÑ§ Í¥ÄÍ≥Ñ"Ï≤òÎüº Îëê Îç∞Ïù¥ÌÑ∞ Í∞ÑÏùò Í¥ÄÍ≥ÑÎ•º ÏßàÎ¨∏ÌïòÎ©¥ Ìù•ÎØ∏Î°úÏö¥ Ïù∏ÏÇ¨Ïù¥Ìä∏Î•º Î∞úÍ≤¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.',
    icon: 'chart',
    example: 'Ïòà: "ÏÜåÎìùÍ≥º ÍµêÌÜµÏãúÏÑ§ Í¥ÄÍ≥Ñ"'
  },
  {
    title: 'Ìä∏Î†åÎìú Î∂ÑÏÑù',
    description: '"ÏµúÍ∑º 3ÎÖÑÍ∞Ñ Î≥ÄÌôî Ï∂îÏù¥"ÎÇò "ÏßÄÏó≠Î≥Ñ ÎπÑÍµê"ÏôÄ Í∞ôÏùÄ ÏãúÍ∞Ñ/Í≥µÍ∞Ñ Í¥ÄÏ†êÏùò ÏßàÎ¨∏ÎèÑ Ïú†Ïö©Ìï©ÎãàÎã§.',
    icon: 'trend',
    example: 'Ïòà: "ÏµúÍ∑º 3ÎÖÑÍ∞Ñ Î≥ÄÌôî Ï∂îÏù¥"'
  }
]

// ÏûêÎèô Ïä¨ÎùºÏù¥Îçî Î°úÏßÅ
let tipSliderInterval = null

const startTipSlider = () => {
  tipSliderInterval = setInterval(() => {
    currentTipIndex.value = (currentTipIndex.value + 1) % analysisTips.length
  }, 4000)
}

const stopTipSlider = () => {
  if (tipSliderInterval) {
    clearInterval(tipSliderInterval)
    tipSliderInterval = null
  }
}

// onMounted Ï∂îÍ∞Ä (Í∏∞Ï°¥ Ìï®ÏàòÎì§ Îí§Ïóê)
if (process.client) {
  startTipSlider()
}

// ÎÇòÎ®∏ÏßÄ computed propertiesÏôÄ functionsÎäî Í∏∞Ï°¥ ÏΩîÎìúÏôÄ ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄ
const tableColumns = computed(() => {
  if (!result.value?.results?.length) return []
  
  if (result.value.queryType === 3) {
    if (result.value.data?.welfare_analysis?.regions?.length) {
      const sampleRow = result.value.data.welfare_analysis.regions[0]
      return Object.keys(sampleRow)
    }
    
    if (result.value.results?.length) {
      return Object.keys(result.value.results[0])
    }
    
    return ['ÏßÄÏó≠Î™Ö', 'Î©¥Ï†Å', 'Î≥µÏßÄÏàòÍ∏âÏûêÏàò', 'Î≤ÑÏä§Ï†ïÎ•òÏû•Ïàò', 'Î≥µÏßÄÎ∞ÄÎèÑ', 'Î≤ÑÏä§Î∞ÄÎèÑ', 'Ï¢ÖÌï©Ï†êÏàò']
  }
  
  return Object.keys(result.value.results[0])
})

const displayResults = computed(() => {
  if (!result.value?.results) return []
  
  if (result.value.queryType === 3) {
    if (result.value.data?.welfare_analysis?.regions?.length) {
      return result.value.data.welfare_analysis.regions.slice(0, 5)
    }
  }
  
  return result.value.results.slice(0, 5)
})

const shouldShowMap = computed(() => {
  if (result.value?.queryType !== 1 || !result.value.results?.length) {
    return false
  }
  
  const firstResult = result.value.results[0]
  const hasCoords = firstResult?.ÏúÑÎèÑ && firstResult?.Í≤ΩÎèÑ
  return hasCoords
})

const shouldShowBarChart = computed(() => {
  return result.value?.queryType && [2, 4].includes(result.value.queryType) && result.value.results?.length > 0
})

const shouldShowAdvancedChart = computed(() => {
  return result.value?.queryType === 4 && result.value.data?.districts?.length > 0
})

const shouldShowPieChart = computed(() => {
  return false
})

const analysisKeywords = computed(() => {
  return result.value?.keywords || []
})

const formattedAnalysis = computed(() => {
  if (!result.value?.analysis) return ''
  return result.value.analysis
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
})

const formatCellValue = (value) => {
  if (value === null || value === undefined || value === '') return '-'
  
  if (typeof value === 'number' || (typeof value === 'string' && !isNaN(parseFloat(value)))) {
    const num = parseFloat(value)
    
    if (isNaN(num)) return String(value)
    
    if (num % 1 !== 0) {
      return num.toFixed(2)
    }
    
    return num.toLocaleString()
  }
  
  return String(value)
}

const executeQuery = async () => {
  if (!userQuery.value.trim()) return
  
  isAdvancedQuery.value = sampleQueries.some(sample => 
    sample.difficulty === 'advanced' && userQuery.value.includes(sample.title.split(' ')[0])
  ) || userQuery.value.includes('ÎπÑÏú®') || userQuery.value.includes('Î≥µÌï©') || userQuery.value.includes('Ï∂îÎ°†')
  
  loading.value = true
  result.value = null
  welfareChartType.value = 'line'
  destroyCharts()
  
  complexReasoningProgress.value = {
    isActive: false,
    currentStep: 0,
    totalSteps: 3,
    stepTitle: '',
    stepDescription: ''
  }
  
  try {
    const queryType = determineQueryType(userQuery.value)
    
    if (queryType === 3) {
      complexReasoningProgress.value.isActive = true
      await simulateComplexReasoningSteps()
    }
    
    const response = await fetch(`${API_BASE_URL}/query/analyze`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        query: userQuery.value,
        queryType: queryType
      })
    })
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    
    const data = await response.json()
    
    result.value = {
      success: data.success,
      queryType: data.queryType,
      sparqlQuery: data.sparqlQuery,
      data: data.data,
      results: data.results,
      analysis: data.analysis,
      keywords: data.keywords || [],
      reasoningSteps: isAdvancedQuery.value ? generateReasoningSteps(data.queryType) : null,
      error: data.success ? null : data.message
    }

    if (data.success && data.results?.length) {
      await nextTick()
      await drawChart()
    }
    
  } catch (err) {
    console.error('Query execution error:', err)
    result.value = { 
      success: false, 
      error: `Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${err.message}`
    }
  } finally {
    loading.value = false
    complexReasoningProgress.value.isActive = false
  }
}

const executeAdvancedQuery = async () => {
  loading.value = true
  destroyCharts()

  // Î≥µÏßÄ Î∂ÑÏÑù ÏßÑÌñâ ÏÉÅÌÉú ÏÑ§Ï†ï (query3)
  complexReasoningProgress.value = {
    isActive: true,
    currentStep: 0,
    totalSteps: 3,
    stepTitle: '',
    stepDescription: ''
  }

  try {
    await simulateComplexReasoningSteps()

    const response = await fetch(`${API_BASE_URL}/query/analyze`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: 'Î≥µÏßÄ Ï∑®ÏïΩÏÑ± Î∂ÑÏÑù',
        queryType: 3
      })
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    const data = await response.json()

    result.value = {
      success: data.success,
      queryType: data.queryType,
      sparqlQuery: data.sparqlQuery,
      data: data.data,
      results: data.results,
      analysis: data.analysis,
      keywords: data.keywords || [],
      reasoningSteps: generateReasoningSteps(3),
      error: data.success ? null : data.message
    }

    if (data.success && data.results?.length) {
      await nextTick()
      await drawChart()
    }

  } catch (err) {
    console.error('Î≥µÏßÄ Î∂ÑÏÑù Ïã§Ìñâ Ïò§Î•ò:', err)
    result.value = {
      success: false,
      error: `Î≥µÏßÄ Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${err.message}`
    }
  } finally {
    loading.value = false
    complexReasoningProgress.value.isActive = false
  }
}

// ÎÇòÎ®∏ÏßÄ Ìï®ÏàòÎì§ÎèÑ Í∏∞Ï°¥Í≥º ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄÌïòÎêò, Ïó¨Í∏∞ÏÑúÎäî ÏÉùÎûµ
const determineQueryType = (query) => {
  const q = query.toLowerCase()
  if (q.includes('Ï†ÑÍ∏∞Ï∞®') || q.includes('Ï∂©Ï†ÑÏÜå')) return 1
  if (q.includes('ÏÜåÎìù') || q.includes('Í≤ΩÏ†ú')) return 2
  if (q.includes('Î≥µÏßÄ') || q.includes('ÏàòÍ∏â')) return 3
  if (q.includes('Î≤ÑÏä§') || q.includes('Ï†ïÎ•òÏû•')) return 4
  return 1
}

const generateReasoningSteps = (queryType) => {
  if (queryType === 3) {
    return [
      {
        step: 1,
        title: "ÌñâÏ†ïÍµ¨Ïó≠ Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏàòÏßë",
        description: "Í∞Å ÏßÄÏó≠Ïùò ÌñâÏ†ïÍµ¨Ïó≠Î™Ö, Î©¥Ï†Å, Ïù∏Íµ¨Ïàò Îì± Í∏∞Î≥∏ Ï†ïÎ≥¥Î•º ÏàòÏßëÌï©ÎãàÎã§.",
        detail: "schema:AdministrativeAreaÎ•º ÌÜµÌï¥ ÏßÄÏó≠Î≥Ñ Í∏∞Î≥∏ Ï†ïÎ≥¥Î•º Ï∂îÏ∂ú"
      },
      {
        step: 2,
        title: "Î≥µÏßÄÏàòÍ∏âÏûê Îç∞Ïù¥ÌÑ∞ ÏßëÍ≥Ñ",
        description: "ÏßÄÏó≠Î≥Ñ Î≥µÏßÄÏàòÍ∏âÏûê ÏàòÎ•º Ìï©ÏÇ∞ÌïòÏó¨ Ï¥ù ÏàòÍ∏âÏûê Í∑úÎ™®Î•º ÌååÏïÖÌï©ÎãàÎã§.",
        detail: "schema:GovernmentServiceÏùò numberOfEmployeesÎ•º ÏßÄÏó≠Î≥ÑÎ°ú GROUP BY ÏßëÍ≥Ñ"
      },
      {
        step: 3,
        title: "ÍµêÌÜµ Ïù∏ÌîÑÎùº ÌòÑÌô© Î∂ÑÏÑù",
        description: "Í∞Å ÏßÄÏó≠Ïùò Î≤ÑÏä§Ï†ïÎ•òÏû• Í∞úÏàòÎ•º Í≥ÑÏÇ∞ÌïòÏó¨ ÍµêÌÜµ Ï†ëÍ∑ºÏÑ±ÏùÑ Ï∏°Ï†ïÌï©ÎãàÎã§.",
        detail: "schema:BusStopÏùÑ ÏßÄÏó≠Î≥ÑÎ°ú COUNTÌïòÏó¨ ÍµêÌÜµ Ïù∏ÌîÑÎùº Î∞ÄÎèÑ Í≥ÑÏÇ∞"
      },
      {
        step: 4,
        title: "Î©¥Ï†Å ÎåÄÎπÑ Î∞ÄÎèÑ ÏßÄÌëú Í≥ÑÏÇ∞",
        description: "Î≥µÏßÄÏàòÍ∏âÏûê Î∞ÄÎèÑÏôÄ Î≤ÑÏä§Ï†ïÎ•òÏû• Î∞ÄÎèÑÎ•º Î©¥Ï†Å ÎåÄÎπÑÎ°ú Ï†ïÍ∑úÌôîÌï©ÎãàÎã§.",
        detail: "Î≥µÏßÄÎ∞ÄÎèÑ = Î≥µÏßÄÏàòÍ∏âÏûêÏàò / Î©¥Ï†Å, Î≤ÑÏä§Î∞ÄÎèÑ = Î≤ÑÏä§Ï†ïÎ•òÏû•Ïàò / Î©¥Ï†Å"
      },
      {
        step: 5,
        title: "Ï¢ÖÌï© Ï∑®ÏïΩÏÑ± Ï†êÏàò ÏÇ∞Ï∂ú",
        description: "Î≥µÏßÄ ÏàòÏöîÎäî ÎÜíÏßÄÎßå ÍµêÌÜµ Ï†ëÍ∑ºÏÑ±Ïù¥ ÎÇÆÏùÄ ÏßÄÏó≠ÏùÑ ÏãùÎ≥ÑÌïòÎäî Ï¢ÖÌï© Ï†êÏàòÎ•º Í≥ÑÏÇ∞Ìï©ÎãàÎã§.",
        detail: "Ï¢ÖÌï©Ï†êÏàò = (Î≥µÏßÄÎ∞ÄÎèÑ √ó 10) - (Î≤ÑÏä§Î∞ÄÎèÑ √ó 5), ÎÜíÏùÑÏàòÎ°ù Ï∑®ÏïΩ"
      }
    ]
  }
  return []
}

const generateAdvancedReasoningSteps = () => {
  return [
    {
      step: 1,
      title: "ÏÜåÎìù Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Î∞è Í≤ÄÏ¶ù",
      description: "ÏßÄÏó≠Î≥Ñ ÌèâÍ∑†ÏÜåÎìù Îç∞Ïù¥ÌÑ∞Î•º ÏàòÏßëÌïòÍ≥† Îç∞Ïù¥ÌÑ∞ ÌíàÏßàÏùÑ Í≤ÄÏ¶ùÌï©ÎãàÎã§.",
      detail: "schema:AdministrativeAreaÏùò amount ÏÜçÏÑ±ÏùÑ ÌÜµÌï¥ ÏßÄÏó≠Î≥Ñ ÏÜåÎìù Ï†ïÎ≥¥ Ï∂îÏ∂ú"
    },
    {
      step: 2,
      title: "Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå ÏúÑÏπò Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù",
      description: "Í∞Å ÏßÄÏó≠Ïóê ÏÑ§ÏπòÎêú Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜåÏùò Í∞úÏàòÎ•º Í≥ÑÏÇ∞Ìï©ÎãàÎã§.",
      detail: "schema:ElectricVehicleChargingStationÏùÑ ÏßÄÏó≠Î≥ÑÎ°ú COUNTÌïòÏó¨ Ï∂©Ï†ÑÏÜå Î∞ÄÎèÑ Í≥ÑÏÇ∞"
    },
    {
      step: 3,
      title: "ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ Î∂ÑÏÑù ÏàòÌñâ",
      description: "ÏÜåÎìù ÏàòÏ§ÄÍ≥º Ï∂©Ï†ÑÏÜå Í∞úÏàò Í∞ÑÏùò ÏÉÅÍ¥ÄÍ¥ÄÍ≥ÑÎ•º ÌÜµÍ≥ÑÏ†ÅÏúºÎ°ú Î∂ÑÏÑùÌï©ÎãàÎã§.",
      detail: "ÏÜåÎìùÍ≥º Ï∂©Ï†ÑÏÜå ÏàòÏùò ÌîºÏñ¥Ïä® ÏÉÅÍ¥ÄÍ≥ÑÏàò Í≥ÑÏÇ∞ Î∞è Ïú†ÏùòÏÑ± Í≤ÄÏ†ï"
    },
    {
      step: 4,
      title: "ÏßÄÏó≠Î≥Ñ Ìå®ÌÑ¥ ÏãùÎ≥Ñ",
      description: "Í≥†ÏÜåÎìù ÏßÄÏó≠Í≥º Ï†ÄÏÜåÎìù ÏßÄÏó≠Ïùò Ï∂©Ï†ÑÏÜå Î∂ÑÌè¨ Ìå®ÌÑ¥ÏùÑ ÎπÑÍµê Î∂ÑÏÑùÌï©ÎãàÎã§.",
      detail: "ÏÜåÎìù Íµ¨Í∞ÑÎ≥Ñ Ï∂©Ï†ÑÏÜå Î∞ÄÎèÑ Ï∞®Ïù¥ Î∂ÑÏÑù Î∞è ÌÜµÍ≥ÑÏ†Å Ïú†ÏùòÏÑ± Í≤ÄÏ†ï"
    },
    {
      step: 5,
      title: "Ï†ïÏ±Ö Ïù∏ÏÇ¨Ïù¥Ìä∏ ÎèÑÏ∂ú",
      description: "Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Î∞îÌÉïÏúºÎ°ú Ï†ÑÍ∏∞Ï∞® Î≥¥Í∏â Ï†ïÏ±ÖÏóê ÎåÄÌïú Ïù∏ÏÇ¨Ïù¥Ìä∏Î•º ÎèÑÏ∂úÌï©ÎãàÎã§.",
      detail: "ÏßÄÏó≠Î≥Ñ ÎßûÏ∂§Ìòï Ï∂©Ï†Ñ Ïù∏ÌîÑÎùº ÌôïÏ∂© Î∞©Ïïà Î∞è Ï†ïÏ±Ö Ï†úÏñ∏ ÎèÑÏ∂ú"
    }
  ]
}

// Î≥µÌï© Ï∂îÎ°† Îã®Í≥ÑÎ≥Ñ ÏßÑÌñâ ÏãúÎÆ¨Î†àÏù¥ÏÖò
const simulateComplexReasoningSteps = async () => {
  const steps = [
    {
      step: 1,
      title: "Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏ Ï§ë",
      description: "Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏ÌïòÍ≥† Í≤ÄÏ¶ùÌï©ÎãàÎã§.",
      duration: 5000
    },
    {
      step: 2,
      title: "Î∂ÑÏÑù ÏßÑÌñâ Ï§ë",
      description: "Î≥µÌï© Ï∂îÎ°† Î∂ÑÏÑùÏùÑ ÏàòÌñâÌïòÍ≥† ÏûàÏäµÎãàÎã§.",
      duration: 10000
    },
    {
      step: 3,
      title: "Î∂ÑÏÑù Í≤∞Í≥º Ï†ïÎ¶¨ Ï§ë",
      description: "Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Ï†ïÎ¶¨ÌïòÍ≥† ÏãúÍ∞ÅÌôîÎ•º Ï§ÄÎπÑÌï©ÎãàÎã§.",
      duration: 10000
    }
  ]

  for (let i = 0; i < steps.length; i++) {
    const step = steps[i]
    
    // ÌòÑÏû¨ Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
    complexReasoningProgress.value.currentStep = step.step
    complexReasoningProgress.value.stepTitle = step.title
    complexReasoningProgress.value.stepDescription = step.description
    
    // Í∞Å Îã®Í≥ÑÎßàÎã§ ÏßÄÏ†ïÎêú ÏãúÍ∞ÑÎßåÌÅº ÎåÄÍ∏∞
    await new Promise(resolve => setTimeout(resolve, step.duration))
  }
}

// Í≥†Í∏â Î∂ÑÏÑù Îã®Í≥ÑÎ≥Ñ ÏßÑÌñâ ÏãúÎÆ¨Î†àÏù¥ÏÖò (query4Ïö©)
const simulateAdvancedReasoningSteps = async () => {
  const steps = [
    {
      step: 1,
      title: "ÏÜåÎìù Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ï§ë",
      description: "ÏßÄÏó≠Î≥Ñ ÏÜåÎìù Îç∞Ïù¥ÌÑ∞Î•º ÏàòÏßëÌïòÍ≥† Í≤ÄÏ¶ùÌï©ÎãàÎã§.",
      duration: 3000
    },
    {
      step: 2,
      title: "Ï∂©Ï†ÑÏÜå Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë",
      description: "Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå ÏúÑÏπò Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÏÑùÌï©ÎãàÎã§.",
      duration: 4000
    },
    {
      step: 3,
      title: "ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ Í≥ÑÏÇ∞ Ï§ë",
      description: "ÏÜåÎìùÍ≥º Ï∂©Ï†ÑÏÜå Í∞ÑÏùò ÏÉÅÍ¥ÄÍ¥ÄÍ≥ÑÎ•º Í≥ÑÏÇ∞Ìï©ÎãàÎã§.",
      duration: 5000
    },
    {
      step: 4,
      title: "Í≤∞Í≥º Ï†ïÎ¶¨ Ï§ë",
      description: "Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Ï†ïÎ¶¨ÌïòÍ≥† Ïù∏ÏÇ¨Ïù¥Ìä∏Î•º ÎèÑÏ∂úÌï©ÎãàÎã§.",
      duration: 3000
    }
  ]

  for (let i = 0; i < steps.length; i++) {
    const step = steps[i]
    
    // ÌòÑÏû¨ Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
    complexReasoningProgress.value.currentStep = step.step
    complexReasoningProgress.value.stepTitle = step.title
    complexReasoningProgress.value.stepDescription = step.description
    
    // Í∞Å Îã®Í≥ÑÎßàÎã§ ÏßÄÏ†ïÎêú ÏãúÍ∞ÑÎßåÌÅº ÎåÄÍ∏∞
    await new Promise(resolve => setTimeout(resolve, step.duration))
  }
}

const loadSampleQuery = (index) => {
  if (index >= 0 && index < sampleQueries.length) {
    userQuery.value = sampleQueries[index].query
  }
}

const refreshPage = () => {
  window.location.reload()
}

const clearResults = () => {
  result.value = null
  userQuery.value = ''
  showQuery.value = false
  destroyCharts()
}

const destroyCharts = () => {
  if (currentChart) {
    currentChart.destroy()
    currentChart = null
  }
  if (currentPieChart) {
    currentPieChart.destroy()
    currentPieChart = null
  }
  if (currentWelfareLineChart) {
    currentWelfareLineChart.destroy()
    currentWelfareLineChart = null
  }
  if (currentWelfareBarChart) {
    currentWelfareBarChart.destroy()
    currentWelfareBarChart = null
  }
  if (currentTopChart) {
    currentTopChart.destroy()
    currentTopChart = null
  }
  if (currentBottomChart) {
    currentBottomChart.destroy()
    currentBottomChart = null
  }
  if (currentMap) {
    currentMap.remove()
    currentMap = null
  }
  currentTileLayer = null
}

const drawChart = async () => {
  if (!result.value?.results?.length) return

  try {
    const queryType = result.value.queryType

    if (queryType === 1 && shouldShowMap.value) {
      await drawMap()
    } else if (queryType === 3) {
      const { Chart, registerables } = await import('chart.js')
      Chart.register(...registerables)
      await drawWelfareCharts(Chart)
    } else if (queryType === 4) {
      // Query 4: ÏÜåÎìù-Ï∂©Ï†ÑÏÜå ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ ÏÇ∞Ï†êÎèÑ
      const { Chart, registerables } = await import('chart.js')
      Chart.register(...registerables)
      await drawScatterChart(Chart)  // ÏÇ∞Ï†êÎèÑ ÏÇ¨Ïö©
    } else if (queryType === 2) {
      const { Chart, registerables } = await import('chart.js')
      Chart.register(...registerables)
      await drawIncomeCharts(Chart)
    }
  } catch (error) {
    console.error('Chart drawing error:', error)
  }
}

// Î≥µÏßÄ Î∂ÑÏÑùÏö© Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞ Ìï®Ïàò
const drawWelfareCharts = async (Chart) => {
  if (!result.value?.results?.length) return

  // Îëê Ï∞®Ìä∏ Î™®Îëê Í∑∏Î¶¨Í∏∞
  await drawWelfareLineChart(Chart)
  await drawWelfareBarChart(Chart)
}

// Î≥µÏßÄ ÏßÄÏó≠Î≥Ñ ÌòÑÌô© ÎùºÏù∏ Ï∞®Ìä∏
const drawWelfareLineChart = async (Chart) => {
  if (!welfareLineChart.value) {
    console.warn('welfareLineChart refÍ∞Ä ÏóÜÏäµÎãàÎã§')
    return
  }

  // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†ïÎ¶¨
  if (currentWelfareLineChart) {
    currentWelfareLineChart.destroy()
    currentWelfareLineChart = null
  }

  try {
    const ctx = welfareLineChart.value.getContext('2d')
    
    // Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§ Í≤∞Ï†ï (Î∞±ÏóîÎìú Ï≤òÎ¶¨ Îç∞Ïù¥ÌÑ∞ Ïö∞ÏÑ†)
    let regions = []
    if (result.value.data?.welfare_analysis?.regions?.length) {
      regions = result.value.data.welfare_analysis.regions.slice(0, 8)
      console.log('Î∞±ÏóîÎìú Ï≤òÎ¶¨ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©:', regions.length, 'Í∞ú ÏßÄÏó≠')
    } else if (result.value.results?.length) {
      regions = result.value.results.slice(0, 8)
      console.log('ÏõêÎ≥∏ SPARQL Í≤∞Í≥º ÏÇ¨Ïö©:', regions.length, 'Í∞ú ÏßÄÏó≠')
    } else {
      console.warn('ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§')
      return
    }

    // Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú Î∞è ÏïàÏ†ÑÌïú Î≥ÄÌôò
    const labels = regions.map(r => {
      const name = r.ÏßÄÏó≠Î™Ö || r.region || 'Ïïå Ïàò ÏóÜÏùå'
      return String(name).length > 10 ? String(name).substring(0, 10) + '...' : String(name)
    })
    
    const areaData = regions.map(r => {
      const area = parseFloat(r.Î©¥Ï†Å || r.area || 0)
      return isNaN(area) ? 0 : area
    })
    
    const welfareData = regions.map(r => {
      const welfare = parseInt(r.Î≥µÏßÄÏàòÍ∏âÏûêÏàò || r.welfare_count || 0)
      return isNaN(welfare) ? 0 : welfare
    })
    
    const busData = regions.map(r => {
      const bus = parseInt(r.Î≤ÑÏä§Ï†ïÎ•òÏû•Ïàò || r.bus_count || 0)
      return isNaN(bus) ? 0 : bus
    })
    
    console.log('Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:', {
      labels: labels.length,
      areas: areaData.filter(v => v > 0).length,
      welfare: welfareData.filter(v => v > 0).length,
      bus: busData.filter(v => v > 0).length
    })

    currentWelfareLineChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Î©¥Ï†Å (km¬≤)',
            data: areaData,
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            yAxisID: 'y'
          },
          {
            label: 'Î≥µÏßÄÏàòÍ∏âÏûêÏàò (Î™Ö)',
            data: welfareData,
            borderColor: '#F59E0B',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            yAxisID: 'y1'
          },
          {
            label: 'Î≤ÑÏä§Ï†ïÎ•òÏû•Ïàò (Í∞ú)',
            data: busData,
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: { size: 12, weight: '500' },
              color: '#374151',
              usePointStyle: true,
              padding: 15
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              label: function(context) {
                const value = context.parsed.y
                const label = context.dataset.label
                
                if (label.includes('Î©¥Ï†Å')) {
                  return `${label}: ${value.toFixed(2)}`
                } else {
                  return `${label}: ${value.toLocaleString()}`
                }
              }
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              color: '#6B7280',
              font: { size: 10 },
              maxRotation: 45
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Î©¥Ï†Å (km¬≤)',
              color: '#10B981',
              font: { size: 11, weight: 'bold' }
            },
            ticks: {
              color: '#10B981',
              font: { size: 10 },
              callback: function(value) {
                return value.toFixed(1)
              }
            },
            grid: { color: '#F3F4F6' }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'ÏàòÎüâ (Î™Ö/Í∞ú)',
              color: '#F59E0B',
              font: { size: 11, weight: 'bold' }
            },
            ticks: {
              color: '#F59E0B',
              font: { size: 10 },
              callback: function(value) {
                return value.toLocaleString()
              }
            },
            grid: { drawOnChartArea: false }
          }
        }
      }
    })
  } catch (error) {
    console.error('Î≥µÏßÄ ÎùºÏù∏ Ï∞®Ìä∏ ÏÉùÏÑ± Ïò§Î•ò:', error)
  }
}

// drawWelfareBarChart Ìï®Ïàò ÏàòÏ†ï (Í∏∞Ï°¥ Ìï®Ïàò ÍµêÏ≤¥)
const drawWelfareBarChart = async (Chart) => {
  if (!welfareBarChart.value) {
    console.warn('welfareBarChart refÍ∞Ä ÏóÜÏäµÎãàÎã§')
    return
  }

  // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†ïÎ¶¨
  if (currentWelfareBarChart) {
    currentWelfareBarChart.destroy()
    currentWelfareBarChart = null
  }

  try {
    const ctx = welfareBarChart.value.getContext('2d')
    
    // Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§ Í≤∞Ï†ï
    let regions = []
    if (result.value.data?.welfare_analysis?.regions?.length) {
      regions = result.value.data.welfare_analysis.regions.slice(0, 10)
      console.log('Î∞±ÏóîÎìú Ï≤òÎ¶¨ Îç∞Ïù¥ÌÑ∞Î°ú Î∞î Ï∞®Ìä∏ ÏÉùÏÑ±:', regions.length, 'Í∞ú ÏßÄÏó≠')
    } else if (result.value.results?.length) {
      regions = result.value.results.slice(0, 10)
      console.log('ÏõêÎ≥∏ SPARQL Í≤∞Í≥ºÎ°ú Î∞î Ï∞®Ìä∏ ÏÉùÏÑ±:', regions.length, 'Í∞ú ÏßÄÏó≠')
    } else {
      console.warn('Î∞î Ï∞®Ìä∏Ïö© Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§')
      return
    }

    const labels = regions.map(r => {
      const name = r.ÏßÄÏó≠Î™Ö || r.region || 'Ïïå Ïàò ÏóÜÏùå'
      return String(name).length > 8 ? String(name).substring(0, 8) + '...' : String(name)
    })
    
    // ÌÖåÏù¥Î∏îÏóê ÌëúÏãúÎêòÎäî Ï†êÏàòÎ•º Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© (Ï∂îÍ∞Ä Ï†ïÍ∑úÌôî ÏóÜÏùå)
    const scores = regions.map(r => {
      let score = 0
      
      // Î∞±ÏóîÎìúÏóêÏÑú Ï≤òÎ¶¨Îêú Ï†ïÍ∑úÌôîÏ†êÏàòÍ∞Ä ÏûàÏúºÎ©¥ Ïö∞ÏÑ† ÏÇ¨Ïö©
      if (r.Ï†ïÍ∑úÌôîÏ†êÏàò !== undefined && r.Ï†ïÍ∑úÌôîÏ†êÏàò !== null) {
        score = parseFloat(r.Ï†ïÍ∑úÌôîÏ†êÏàò)
        console.log(`${r.ÏßÄÏó≠Î™Ö}: Ï†ïÍ∑úÌôîÏ†êÏàò ÏÇ¨Ïö© = ${score}`)
      }
      // Ï†ïÍ∑úÌôîÏ†êÏàòÍ∞Ä ÏóÜÏúºÎ©¥ Ï¢ÖÌï©Ï†êÏàò ÏÇ¨Ïö©
      else if (r.Ï¢ÖÌï©Ï†êÏàò !== undefined && r.Ï¢ÖÌï©Ï†êÏàò !== null) {
        score = parseFloat(r.Ï¢ÖÌï©Ï†êÏàò)
        console.log(`${r.ÏßÄÏó≠Î™Ö}: Ï¢ÖÌï©Ï†êÏàò ÏÇ¨Ïö© = ${score}`)
      }
      // Îëò Îã§ ÏóÜÏúºÎ©¥ 0
      else {
        score = 0
        console.log(`${r.ÏßÄÏó≠Î™Ö}: Ï†êÏàò ÏóÜÏùå, 0ÏúºÎ°ú ÏÑ§Ï†ï`)
      }
      
      return isNaN(score) ? 0 : score
    })
    
    // *** Ï§ëÏöî: Ï∂îÍ∞Ä Ï†ïÍ∑úÌôî Ï†úÍ±∞ - Î∞±ÏóîÎìúÏóêÏÑú Í≥ÑÏÇ∞Îêú Í∞í Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© ***
    const finalScores = scores
    
    console.log('ÏµúÏ¢Ö Ï∞®Ìä∏ Ï†êÏàò (Ï†ïÍ∑úÌôî ÏóÜÏùå):', finalScores)
    
    // Ï†êÏàòÏóê Îî∞Î•∏ ÏÉâÏÉÅ Í≤∞Ï†ï
    const colors = finalScores.map(score => {
      if (score >= 80) return '#DC2626' // ÎÜíÏùÄ Ï∑®ÏïΩÏÑ± - Îπ®Í∞ÑÏÉâ
      if (score >= 60) return '#F59E0B' // Ï§ëÍ∞Ñ Ï∑®ÏïΩÏÑ± - Ï£ºÌô©ÏÉâ
      if (score >= 40) return '#10B981' // Î≥¥ÌÜµ - Ï¥àÎ°ùÏÉâ
      return '#6B7280' // ÎÇÆÏùÄ Ï∑®ÏïΩÏÑ± - ÌöåÏÉâ
    })

    console.log('Î∞î Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:', {
      labels: labels,
      scores: finalScores,
      colors: colors.slice(0, 3)
    })

    currentWelfareBarChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Î≥µÏßÄ Ï∑®ÏïΩÏÑ± Ï†êÏàò',
          data: finalScores,  // Î∞±ÏóîÎìú Í≥ÑÏÇ∞Í∞í Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
          backgroundColor: colors,
          borderColor: colors,
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                const score = context.parsed.y
                let level = ''
                if (score >= 80) level = 'ÎÜíÏùÄ Ï∑®ÏïΩÏÑ±'
                else if (score >= 60) level = 'Ï§ëÍ∞Ñ Ï∑®ÏïΩÏÑ±'
                else if (score >= 40) level = 'Î≥¥ÌÜµ'
                else level = 'ÎÇÆÏùÄ Ï∑®ÏïΩÏÑ±'
                
                return `${context.dataset.label}: ${score.toFixed(1)}Ï†ê (${level})`
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            // max Í∞íÏùÑ ÎèôÏ†ÅÏúºÎ°ú ÏÑ§Ï†ï (Ï†ïÍ∑úÌôîÏ†êÏàòÎ©¥ 100, Ï¢ÖÌï©Ï†êÏàòÎ©¥ ÏûêÎèô)
            max: finalScores.some(s => s > 100) ? undefined : 100,
            title: {
              display: true,
              text: 'Ï∑®ÏïΩÏÑ± Ï†êÏàò',
              color: '#374151',
              font: { size: 12, weight: 'bold' }
            },
            ticks: {
              color: '#6B7280',
              font: { size: 11 },
              callback: function(value) {
                return value.toFixed(0) + 'Ï†ê'
              }
            },
            grid: { color: '#F3F4F6' }
          },
          x: {
            ticks: {
              color: '#6B7280',
              font: { size: 10 },
              maxRotation: 45,
              minRotation: 0
            },
            grid: { display: false }
          }
        }
      }
    })
  } catch (error) {
    console.error('Î≥µÏßÄ Î∞î Ï∞®Ìä∏ ÏÉùÏÑ± Ïò§Î•ò:', error)
  }
}

const destroyWelfareCharts = () => {
  if (currentWelfareLineChart) {
    currentWelfareLineChart.destroy()
    currentWelfareLineChart = null
  }
  if (currentWelfareBarChart) {
    currentWelfareBarChart.destroy()
    currentWelfareBarChart = null
  }
}

// Í≥†Í∏â Î∂ÑÏÑù Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞ (ÏÜåÎìùÍ≥º Ï∂©Ï†ÑÏÜå ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ)
const drawAdvancedChart = async (Chart) => {
  if (!chartCanvas.value) {
    console.warn('chartCanvas refÍ∞Ä ÏóÜÏäµÎãàÎã§')
    return
  }

  // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†ïÎ¶¨
  if (currentChart) {
    currentChart.destroy()
    currentChart = null
  }

  try {
    const ctx = chartCanvas.value.getContext('2d')
    
    // Í≥†Í∏â Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
    const districts = result.value.data?.districts || []
    const correlation = result.value.data?.correlation || 0
    
    if (districts.length === 0) {
      console.warn('Í≥†Í∏â Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§')
      return
    }

    // ÏÉÅÏúÑ 10Í∞ú ÏßÄÏó≠Îßå ÌëúÏãú
    const topDistricts = districts.slice(0, 10)
    
    const labels = topDistricts.map(d => {
      const name = d.name || 'Ïïå Ïàò ÏóÜÏùå'
      return String(name).length > 8 ? String(name).substring(0, 8) + '...' : String(name)
    })
    
    const incomes = topDistricts.map(d => d.income || 0)
    const stations = topDistricts.map(d => d.chargingStations || 0)
    
    console.log('Í≥†Í∏â Î∂ÑÏÑù Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞:', {
      labels: labels.length,
      incomes: incomes.filter(v => v > 0).length,
      stations: stations.filter(v => v > 0).length,
      correlation: correlation
    })

    currentChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'ÌèâÍ∑†ÏÜåÎìù (ÎßåÏõê)',
            data: incomes,
            backgroundColor: '#10B981',
            borderRadius: 8,
            borderColor: '#ffffff',
            borderWidth: 2,
            borderSkipped: false,
            yAxisID: 'y'
          },
          {
            label: 'Ï∂©Ï†ÑÏÜå Ïàò (Í∞ú)',
            data: stations,
            backgroundColor: '#8B5CF6',
            borderRadius: 8,
            borderColor: '#ffffff',
            borderWidth: 2,
            borderSkipped: false,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: {
                size: 13,
                weight: '500'
              },
              color: '#374151',
              usePointStyle: true,
              padding: 20
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              label: function(context) {
                const value = context.parsed.y
                const label = context.dataset.label
                
                if (label.includes('ÏÜåÎìù')) {
                  return `${label}: ${value.toLocaleString()}ÎßåÏõê`
                } else {
                  return `${label}: ${value}Í∞ú`
                }
              }
            },
            title: {
              display: true,
              text: `ÏÉÅÍ¥ÄÍ≥ÑÏàò: ${correlation.toFixed(3)} (${correlation > 0.5 ? 'Í∞ïÌïú ÏñëÏùò ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ' : correlation > 0.3 ? 'Ï§ëÍ∞Ñ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ' : 'ÏïΩÌïú ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ'})`,
              color: '#374151',
              font: {
                size: 14,
                weight: 'bold'
              },
              padding: 20
            }
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'ÌèâÍ∑†ÏÜåÎìù (ÎßåÏõê)',
              color: '#10B981',
              font: { size: 12, weight: 'bold' }
            },
            ticks: {
              color: '#10B981',
              font: { size: 11 },
              callback: function(value) {
                return value.toLocaleString() + 'ÎßåÏõê'
              }
            },
            grid: { color: '#F3F4F6' }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Ï∂©Ï†ÑÏÜå Ïàò (Í∞ú)',
              color: '#8B5CF6',
              font: { size: 12, weight: 'bold' }
            },
            ticks: {
              color: '#8B5CF6',
              font: { size: 11 },
              callback: function(value) {
                return value + 'Í∞ú'
              }
            },
            grid: { drawOnChartArea: false }
          },
          x: {
            ticks: {
              color: '#6B7280',
              font: { size: 10 },
              maxRotation: 45,
              minRotation: 0
            },
            grid: { display: false }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    })
  } catch (error) {
    console.error('Í≥†Í∏â Î∂ÑÏÑù Ï∞®Ìä∏ ÏÉùÏÑ± Ïò§Î•ò:', error)
  }
}

// ÏÜåÎìù Î∂ÑÌè¨ Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞ (ÏÉÅÏúÑ 10Í∞ú, ÌïòÏúÑ 10Í∞ú Î∂ÑÎ¶¨)
const drawIncomeCharts = async (Chart) => {
  if (!result.value?.results?.length) return

  // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†ïÎ¶¨
  if (currentTopChart) {
    currentTopChart.destroy()
    currentTopChart = null
  }
  if (currentBottomChart) {
    currentBottomChart.destroy()
    currentBottomChart = null
  }

  try {
    // ÏÜåÎìù Îç∞Ïù¥ÌÑ∞ Ï†ïÎ†¨
    const sortedData = result.value.results
      .map(r => ({
        region: r.ÏßÄÏó≠Î™Ö || 'Ïïå Ïàò ÏóÜÏùå',
        income: parseInt(r.ÌèâÍ∑†ÏÜåÎìù || r.income || 0) || 0
      }))
      .sort((a, b) => b.income - a.income)

    // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÏµúÎåìÍ∞í Ï∞æÍ∏∞
    const maxIncome = Math.max(...sortedData.map(d => d.income))
    // Ïó¨Ïú† Í≥µÍ∞ÑÏùÑ ÏúÑÌï¥ 10% Ï∂îÍ∞Ä
    const yAxisMax = Math.ceil(maxIncome * 1.1)

    // ÏÉÅÏúÑ 10Í∞úÏôÄ ÌïòÏúÑ 10Í∞ú ÏÑ†ÌÉù
    const topRegions = sortedData.slice(0, 10)
    const bottomRegions = sortedData.slice(-10).reverse() // Ïó≠ÏàúÏúºÎ°ú Ï†ïÎ†¨ÌïòÏó¨ Í∞ÄÏû• ÎÇÆÏùÄ Í≤ÉÎ∂ÄÌÑ∞

    // Í≥µÌÜµ yÏ∂ï ÏÑ§Ï†ï ÏòµÏÖò
    const yAxisOptions = {
      beginAtZero: true,
      max: yAxisMax, // ÎèôÏùºÌïú ÏµúÎåìÍ∞í ÏÑ§Ï†ï
      grid: {
        color: '#F3F4F6',
        drawBorder: false
      },
      ticks: {
        color: '#6B7280',
        font: {
          size: 11
        },
        callback: function(value) {
          return value.toLocaleString() + 'ÎßåÏõê'
        }
      }
    }

    // ÏÉÅÏúÑ 10Í∞ú Ï∞®Ìä∏
    if (topChartCanvas.value) {
      const topCtx = topChartCanvas.value.getContext('2d')
      
      currentTopChart = new Chart(topCtx, {
        type: 'bar',
        data: {
          labels: topRegions.map(d => {
            const name = d.region
            return name.length > 8 ? name.substring(0, 8) + '...' : name
          }),
          datasets: [{
            label: 'ÌèâÍ∑†ÏÜåÎìù (ÎßåÏõê)',
            data: topRegions.map(d => d.income),
            backgroundColor: '#10B981', // Emerald-500
            borderRadius: 8,
            borderColor: '#ffffff',
            borderWidth: 2,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#374151',
              borderWidth: 1,
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}ÎßåÏõê`
                }
              }
            }
          },
          scales: {
            y: yAxisOptions, // Í≥µÌÜµ yÏ∂ï ÏòµÏÖò Ï†ÅÏö©
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#6B7280',
                font: {
                  size: 10
                },
                maxRotation: 45,
                minRotation: 0
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      })
    }

    // ÌïòÏúÑ 10Í∞ú Ï∞®Ìä∏
    if (bottomChartCanvas.value) {
      const bottomCtx = bottomChartCanvas.value.getContext('2d')
      
      currentBottomChart = new Chart(bottomCtx, {
        type: 'bar',
        data: {
          labels: bottomRegions.map(d => {
            const name = d.region
            return name.length > 8 ? name.substring(0, 8) + '...' : name
          }),
          datasets: [{
            label: 'ÌèâÍ∑†ÏÜåÎìù (ÎßåÏõê)',
            data: bottomRegions.map(d => d.income),
            backgroundColor: '#F59E0B', // Amber-500
            borderRadius: 8,
            borderColor: '#ffffff',
            borderWidth: 2,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#374151',
              borderWidth: 1,
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}ÎßåÏõê`
                }
              }
            }
          },
          scales: {
            y: yAxisOptions, // Í≥µÌÜµ yÏ∂ï ÏòµÏÖò Ï†ÅÏö©
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#6B7280',
                font: {
                  size: 10
                },
                maxRotation: 45,
                minRotation: 0
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      })
    }

  } catch (error) {
    console.error('Income charts creation error:', error)
  }
}

// query4 ÏÇ∞Ï†êÎèÑ Ï∞®Ìä∏
const drawScatterChart = async (Chart) => {
  if (!chartCanvas.value) {
    console.warn('chartCanvas refÍ∞Ä ÏóÜÏäµÎãàÎã§')
    return
  }

  // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†ïÎ¶¨
  if (currentChart) {
    currentChart.destroy()
    currentChart = null
  }

  try {
    const ctx = chartCanvas.value.getContext('2d')
    
    // Query 4 Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
    const districts = result.value.data?.districts || []
    const correlation = result.value.data?.correlation || {}
    
    if (districts.length === 0) {
      console.warn('ÏÇ∞Ï†êÎèÑÏö© Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§')
      return
    }

    console.log('ÏÇ∞Ï†êÎèÑ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:', {
      districts: districts.length,
      correlation: correlation.coefficient,
      sampleData: districts.slice(0, 3)
    })

    // ÏÇ∞Ï†êÎèÑ Îç∞Ïù¥ÌÑ∞ Ìè¨Ïù∏Ìä∏ ÏÉùÏÑ±
    const scatterData = districts.map(d => ({
      x: d.income || 0,           // XÏ∂ï: ÏÜåÎìù
      y: d.chargerCount || 0,     // YÏ∂ï: Ï∂©Ï†ÑÏÜå Ïàò (ÏàòÏ†ïÎê®!)
      label: d.name || 'Ïïå Ïàò ÏóÜÏùå'
    })).filter(point => point.x > 0 && point.y > 0) // Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Îßå

    console.log('ÏÇ∞Ï†êÎèÑ Ìè¨Ïù∏Ìä∏:', scatterData.slice(0, 3))

    // Ï∂îÏÑ∏ÏÑ† Í≥ÑÏÇ∞
    let trendlineData = []
    if (scatterData.length > 1) {
      const x = scatterData.map(d => d.x)
      const y = scatterData.map(d => d.y)
      
      const n = x.length
      const meanX = x.reduce((a, b) => a + b, 0) / n
      const meanY = y.reduce((a, b) => a + b, 0) / n
      
      let numerator = 0
      let denominator = 0
      
      for (let i = 0; i < n; i++) {
        numerator += (x[i] - meanX) * (y[i] - meanY)
        denominator += (x[i] - meanX) ** 2
      }
      
      if (denominator !== 0) {
        const slope = numerator / denominator
        const intercept = meanY - slope * meanX
        
        const minX = Math.min(...x)
        const maxX = Math.max(...x)
        
        trendlineData = [
          { x: minX, y: slope * minX + intercept },
          { x: maxX, y: slope * maxX + intercept }
        ]
        
        console.log('Ï∂îÏÑ∏ÏÑ† Í≥ÑÏÇ∞ ÏôÑÎ£å:', { slope, intercept, points: trendlineData })
      }
    }

    // Ï∞®Ìä∏ ÏÉùÏÑ±
    const datasets = [
      {
        label: 'ÏßÄÏó≠Î≥Ñ ÏÜåÎìù-Ï∂©Ï†ÑÏÜå Î∂ÑÌè¨',
        data: scatterData,
        backgroundColor: 'rgba(99, 102, 241, 0.7)',
        borderColor: 'rgba(99, 102, 241, 1)',
        pointRadius: 8,
        pointHoverRadius: 12,
        pointBorderWidth: 2,
        pointBorderColor: '#ffffff'
      }
    ]

    // Ï∂îÏÑ∏ÏÑ†Ïù¥ ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
    if (trendlineData.length > 0) {
      datasets.push({
        type: 'line',
        label: `Ï∂îÏÑ∏ÏÑ† (r=${(correlation.coefficient || 0).toFixed(3)})`,
        data: trendlineData,
        borderColor: '#EF4444', // Îπ®Í∞ÑÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        borderWidth: 4, // Í∏∞Ï°¥ 3ÏóêÏÑú 4Î°ú Ï¶ùÍ∞Ä
        fill: false,
        pointRadius: 0,
        pointHoverRadius: 0,
        tension: 0,
        order: 1
      })
    }

    currentChart = new Chart(ctx, {
      type: 'scatter',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 1.5,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: { size: 12, weight: '500' },
              color: '#374151',
              usePointStyle: true,
              padding: 15
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              title: function(context) {
                if (context.length > 0) {
                  const point = context[0].raw
                  return point.label || 'ÏßÄÏó≠'
                }
                return ''
              },
              label: function(context) {
                const point = context.raw
                if (context.dataset.label.includes('Ï∂îÏÑ∏ÏÑ†')) {
                  return null // Ï∂îÏÑ∏ÏÑ† Ìà¥ÌåÅÏùÄ Ïà®ÍπÄ
                }
                return [
                  `ÌèâÍ∑†ÏÜåÎìù: ${point.x.toLocaleString()}ÎßåÏõê`,
                  `Ï∂©Ï†ÑÏÜå Ïàò: ${point.y}Í∞ú`
                ]
              },
              afterBody: function() {
                const corr = correlation.coefficient || 0
                const strength = correlation.strength || 'Ïïå Ïàò ÏóÜÏùå'
                return `\nÏÉÅÍ¥ÄÍ≥ÑÏàò: ${corr.toFixed(3)} (${strength})`
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'ÌèâÍ∑†ÏÜåÎìù (ÎßåÏõê)',
              color: '#374151',
              font: { size: 13, weight: 'bold' }
            },
            ticks: {
              color: '#6B7280',
              font: { size: 11 },
              callback: function(value) {
                return value.toLocaleString() + 'ÎßåÏõê'
              }
            },
            grid: { color: '#F3F4F6' }
          },
          y: {
            title: {
              display: true,
              text: 'Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå Ïàò (Í∞ú)',
              color: '#374151',
              font: { size: 13, weight: 'bold' }
            },
              max: 200,
              ticks: {
                color: '#6B7280',
                font: { size: 11 },
                stepSize: 50, // Ìïú Ïπ∏Ïùò ÌÅ¨Í∏∞Î•º 50ÏúºÎ°ú ÏÑ§Ï†ï
                callback: function(value) {
                  return value + 'Í∞ú'
                }
              },
              grid: { color: '#F3F4F6' }
          }
        },
        interaction: {
          intersect: false,
          mode: 'point'
        }
      }
    })

    console.log('ÏÇ∞Ï†êÎèÑ Ï∞®Ìä∏ ÏÉùÏÑ± ÏôÑÎ£å')

  } catch (error) {
    console.error('ÏÇ∞Ï†êÎèÑ Ï∞®Ìä∏ ÏÉùÏÑ± Ïò§Î•ò:', error)
  }
}

// Í≤∞Í≥ºÍ∞Ä Î≥ÄÍ≤ΩÎê† ÎïåÎßàÎã§ Ï∞®Ìä∏ Îã§Ïãú Í∑∏Î¶¨Í∏∞
watch(() => result.value?.results, async (newResults) => {
  if (newResults?.length) {
    await nextTick()
    await drawChart()
  }
})

const drawMap = async () => {
  destroyCharts()
  
  // DOMÏù¥ ÏôÑÏ†ÑÌûà Î†åÎçîÎßÅÎê† ÎïåÍπåÏßÄ Í∏∞Îã§Î¶º
  await nextTick()
  
  // mapContainerÍ∞Ä Ï§ÄÎπÑÎê† ÎïåÍπåÏßÄ Í∏∞Îã§Î¶º
  let attempts = 0
  while (!mapContainer.value && attempts < 10) {
    await new Promise(resolve => setTimeout(resolve, 100))
    attempts++
  }
  
  if (!mapContainer.value) {
    console.log('Map container not ready after 10 attempts')
    return
  }

  try {
    const L = await import('leaflet')
    
    // Leaflet CSSÎèÑ ÎèôÏ†ÅÏúºÎ°ú Î°úÎìú
    if (!document.querySelector('link[href*="leaflet"]')) {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'
      document.head.appendChild(link)
    }

    // SVG ÏïÑÏù¥ÏΩò ÏÉùÏÑ± Ìï®Ïàò
    const createSVGIcon = (color = '#4F46E5') => {
      const svgString = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="${color}" stroke="white" stroke-width="2"/>
          <circle cx="12" cy="9" r="2.5" fill="white"/>
        </svg>
      `
      
      return L.divIcon({
        html: svgString,
        className: 'custom-svg-icon',
        iconSize: [24, 24],
        iconAnchor: [12, 24],
        popupAnchor: [0, -24]
      })
    }

    // CSS Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä (Í∑∏Î¶ºÏûê Ìö®Í≥º)
    if (!document.querySelector('#leaflet-svg-styles')) {
      const style = document.createElement('style')
      style.id = 'leaflet-svg-styles'
      style.textContent = `
        .custom-svg-icon {
          background: none !important;
          border: none !important;
          filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
      `
      document.head.appendChild(style)
    }

    // Ï≤´ Î≤àÏß∏ Ï∂©Ï†ÑÏÜå ÏúÑÏπòÎ•º Ï§ëÏã¨ÏúºÎ°ú ÏßÄÎèÑ ÏÉùÏÑ±
    const firstStation = result.value.results[2]
    const centerLat = parseFloat(firstStation.ÏúÑÎèÑ) || 37.5665
    const centerLng = parseFloat(firstStation.Í≤ΩÎèÑ) || 126.9780

    currentMap = L.map(mapContainer.value).setView([centerLat, centerLng], 13)

    // Í∏∞Î≥∏ Ïä§ÌÉÄÏùºÎ°ú OpenStreetMap ÏÇ¨Ïö©
    const selectedStyle = mapStyleOptions.openstreetmap
    currentTileLayer = L.tileLayer(selectedStyle.url, {
      attribution: selectedStyle.attribution
    }).addTo(currentMap)

    // Ï∂©Ï†ÑÏÜå ÎßàÏª§ Ï∂îÍ∞Ä
    let markerCount = 0
    result.value.results.forEach((station, index) => {
      const lat = parseFloat(station.ÏúÑÎèÑ)
      const lng = parseFloat(station.Í≤ΩÎèÑ)
      
      if (!isNaN(lat) && !isNaN(lng)) {
        const iconColor = '#4F46E5'
        const customIcon = createSVGIcon(iconColor)
        
        const marker = L.marker([lat, lng], { icon: customIcon }).addTo(currentMap)
        markerCount++
        
        // ÌåùÏóÖ ÎÇ¥Ïö© ÏÉùÏÑ±
        const popupContent = `
          <div class="p-2">
            <h3 class="font-bold text-sm mb-1">${station.Ï∂©Ï†ÑÏÜåÎ™Ö || 'Ï∂©Ï†ÑÏÜå'}</h3>
            <p class="text-xs text-gray-600 mb-1">${station.Ï£ºÏÜå || 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
          </div>
        `
        
        marker.bindPopup(popupContent)
      }
    })

    console.log(`Added ${markerCount} markers to map`)

  } catch (error) {
    console.error('Map creation error:', error)
  }
}

// Î≥µÏßÄ(3) Î∂ÑÏÑù Ïã§Ìñâ Î∞è Í≤∞Í≥º Î∞òÏòÅ Ìï®Ïàò
const onClickExecuteAdvancedQuery = async () => {
  if (loading.value) return
  
  // ÏÇ¨Ïö©Ïûê ÏøºÎ¶¨ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
  userQuery.value = 'ÏßÄÏó≠Î≥Ñ ÏÜåÎìùÍ≥º Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå Í∞úÏàòÏùò ÏÉÅÍ¥ÄÍ¥ÄÍ≥ÑÎ•º Î∂ÑÏÑùÌï¥Ï§ò'
  
  loading.value = true
  destroyCharts()
  
  // Í≥†Í∏â Î∂ÑÏÑù ÏßÑÌñâ ÏÉÅÌÉú ÏÑ§Ï†ï (query4 - ÏÜåÎìùÍ≥º Ï∂©Ï†ÑÏÜå ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ)
  complexReasoningProgress.value = {
    isActive: true,
    currentStep: 0,
    totalSteps: 4,
    stepTitle: '',
    stepDescription: ''
  }

  try {
    await simulateAdvancedReasoningSteps()

    const response = await fetch(`${API_BASE_URL}/query/analyze/advanced`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: 'ÏßÄÏó≠Î≥Ñ ÏÜåÎìùÍ≥º Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå Í∞úÏàòÏùò ÏÉÅÍ¥ÄÍ¥ÄÍ≥ÑÎ•º Î∂ÑÏÑùÌï¥Ï§ò',
        queryType: 4
      })
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    const data = await response.json()

    result.value = {
      success: data.success,
      queryType: data.queryType,
      sparqlQuery: data.sparqlQuery,
      data: data.data,
      results: data.results,
      analysis: data.analysis,
      keywords: data.keywords || [],
      reasoningSteps: generateAdvancedReasoningSteps(),
      error: data.success ? null : data.message
    }

    if (data.success && data.results?.length) {
      await nextTick()
      await drawChart()
    }

  } catch (err) {
    console.error('Í≥†Í∏â Î∂ÑÏÑù Ïã§Ìñâ Ïò§Î•ò:', err)
    result.value = {
      success: false,
      error: `Í≥†Í∏â Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${err.message}`
    }
  } finally {
    loading.value = false
    complexReasoningProgress.value.isActive = false
  }
}


// Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú Ï∞®Ìä∏ Ï†ïÎ¶¨
onUnmounted(() => {
  stopTipSlider()
  destroyCharts()
})
</script>

<style scoped>
.animate-spin {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.prose {
  line-height: 1.6;
}

.prose strong {
  font-weight: 600;
  color: #374151;
}
</style>